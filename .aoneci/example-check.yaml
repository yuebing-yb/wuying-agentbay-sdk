name: "Multi-Language Examples Inspection"

triggers:
  # Manual trigger is implied, remove explicit manual config if it's invalid
  # schedule:
  #   - cron: "0 2 * * *"  # Run daily at 2:00 AM

params:
  python:
    name: Python Examples
    type: boolean
    default: true
  typescript:
    name: TypeScript Examples
    type: boolean
    default: true
  golang:
    name: Golang Examples
    type: boolean
    default: true

jobs:
  example-check:
    name: "Examples Inspection"
    runs-on:
      - "4-16Gi"
    image: alios-8u
    timeout: 5h
    retry:
      max: 1
      when:
        - runner_system_failure
    steps:
      - uses: checkout
      
      - uses: setup-env
        inputs:
          python-version: '3.10'
          node-version: '18'
          npm-version: '10'
          go-version: '1.24.3'
          
      - id: run-checks
        name: "Run Example Checks"
        run: |
          echo "ğŸ”§ Setting up Environment..."
          
          # Install Python Dependencies
          echo "ğŸ Setting up Python..."
          python -m pip install --upgrade pip
          python -m pip install -e ./python/
          python -m pip install pytest playwright python-dotenv langchain-openai langgraph langchain-core
          playwright install chromium || echo "âš ï¸ Playwright install failed"
          if [ -f "python/requirements.txt" ]; then
            python -m pip install -r python/requirements.txt
          fi
          
          # Install TypeScript Dependencies
          echo "ğŸ“œ Setting up TypeScript..."
          if [ "${{params.typescript}}" == "true" ]; then
            cd typescript
            npm ci
            npm run build
            npm link
            npm link wuying-agentbay-sdk
            npm install --no-save ts-node
            npx playwright install chromium || echo "âš ï¸ Playwright install failed"
            cd ..
          fi
          
          # Install Golang Dependencies
          echo "ğŸ¹ Setting up Golang..."
          if [ "${{params.golang}}" == "true" ]; then
            cd golang
            go env -w GOPROXY=https://goproxy.cn,direct
            go mod download
            go run github.com/playwright-community/playwright-go/cmd/playwright@latest install chromium || echo "âš ï¸ Playwright install failed"
            cd ..
          fi
          
          echo "ğŸš€ Starting Examples Inspection..."
          export AGENTBAY_API_KEY="${{secrets.AGENTBAY_API_KEY}}"
          export DASHSCOPE_API_KEY="${{secrets.DASHSCOPE_API_KEY}}"
          
          # Run checks sequentially but capture failures
          FAILED=false
          
          if [ "${{params.python}}" == "true" ]; then
            echo "=== Running Python Checks ==="
            set +e
            python scripts/check_examples.py --lang python
            if [ $? -ne 0 ]; then FAILED=true; fi
            set -e
          fi
          
          if [ "${{params.typescript}}" == "true" ]; then
            echo "=== Running TypeScript Checks ==="
            set +e
            python scripts/check_examples.py --lang typescript
            if [ $? -ne 0 ]; then FAILED=true; fi
            set -e
          fi
          
          if [ "${{params.golang}}" == "true" ]; then
            echo "=== Running Golang Checks ==="
            set +e
            python scripts/check_examples.py --lang golang
            if [ $? -ne 0 ]; then FAILED=true; fi
            set -e
          fi
          
          # Display report if exists
          if [ -f "example_check_report.md" ]; then
            echo ""
            echo "=========================================="
            echo "      Examples Inspection Report"
            echo "=========================================="
            echo ""
            cat example_check_report.md
            
            # Also append to CI summary
            cat example_check_report.md >> $AONE_CI_SUMMARY_MD
          fi
          
          if [ "$FAILED" = "true" ]; then
            echo "âŒ One or more example checks failed."
            exit 1
          else
            echo "âœ… All enabled checks passed successfully."
            exit 0
          fi
          
      - id: display-example-results
        name: "Display Example Results"
        if: always()
        run: |
          if [ -f "example_check_report.md" ]; then
            # Show success summary from the summary line
            if grep -q "Examples |" example_check_report.md; then
              SUMMARY_LINE=$(grep "Examples |" example_check_report.md | head -1)
              echo "ğŸ“Š $SUMMARY_LINE"
              echo ""
            fi
            
            # Create individual collapsible sections for each failed example - only show AI fix prompt
            if grep -q "âŒ å¤±è´¥ç¤ºä¾‹" example_check_report.md; then
              echo "ğŸ“‹ å¤±è´¥ç¤ºä¾‹æ¦‚è§ˆï¼š"
              echo ""
              
              # Process each failed example and only show AI fix prompt in collapsible sections
              awk '
              BEGIN { 
                example_count = 0;
                in_example = 0;
                example_id = "";
                fix_prompt = "";
                current_section = "";
              }
              
              /^âŒ å¤±è´¥ç¤ºä¾‹/ {
                # If we have a previous example, output it
                if (example_count > 0 && example_id != "" && fix_prompt != "") {
                  print "::group::" example_count ". " example_id " - ğŸ› ï¸ AIä¿®å¤æç¤ºè¯";
                  print "```";
                  print fix_prompt;
                  print "```";
                  print "::endgroup::";
                  print "";
                }
                
                # Start new example
                example_count++;
                in_example = 1;
                example_id = "";
                fix_prompt = "";
                current_section = "";
                
                # Read next line which should contain the example ID
                if (getline > 0 && /^ç¤ºä¾‹ID:/) {
                  # Extract example ID from "ç¤ºä¾‹ID: example_id_here"
                  gsub(/^ç¤ºä¾‹ID: /, "", $0);
                  example_id = $0;
                }
                next;
              }
              
              /^ğŸ› ï¸ AIä¿®å¤æç¤ºè¯/ && in_example {
                current_section = "fix_prompt";
                next;
              }
              
              /^```/ && in_example {
                # Skip code block markers
                next;
              }
              
              /^---$/ && in_example {
                # End of current example section
                in_example = 0;
                current_section = "";
                next;
              }
              
              in_example && current_section == "fix_prompt" {
                fix_prompt = fix_prompt $0 "\n";
              }
              
              END {
                # Output the last example if exists
                if (example_count > 0 && example_id != "" && fix_prompt != "") {
                  print "::group::" example_count ". " example_id " - ğŸ› ï¸ AIä¿®å¤æç¤ºè¯";
                  print "```";
                  print fix_prompt;
                  print "```";
                  print "::endgroup::";
                }
              }
              ' example_check_report.md
              
            else
              echo "âœ… æ‰€æœ‰ç¤ºä¾‹éƒ½é€šè¿‡äº†ï¼"
            fi
          else
            echo "âš ï¸ ç¤ºä¾‹æ£€æŸ¥æŠ¥å‘Šæ–‡ä»¶ä¸å­˜åœ¨"
          fi
