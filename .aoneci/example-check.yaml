name: "Multi-Language Examples Inspection"

triggers:
  # Manual trigger is implied, remove explicit manual config if it's invalid
  # schedule:
  #   - cron: "0 2 * * *"  # Run daily at 2:00 AM

params:
  python:
    name: Python Examples
    type: boolean
    default: true
  typescript:
    name: TypeScript Examples
    type: boolean
    default: true
  golang:
    name: Golang Examples
    type: boolean
    default: true

traits:
  - type: notification
    properties:
      types: dingtalk
      when: all
      users: 187788
      content: |
        ---
        - **Example Check Report**
            - @${{git.repo}}
            - **Branch**: ${{git.branch}}
            - **Commit**: ${{git.commitId}}
            - **Changed By**: ${{git.employeeId}}
                      
        ğŸ“ **å¤šè¯­è¨€ç¤ºä¾‹æ£€æŸ¥æŠ¥å‘Š**
        
        ğŸ“Š **æ£€æŸ¥ç»“æœï¼š** ${{jobs.example-check.outputs.example_summary}}
        
        **å¤±è´¥è¯¦æƒ…ï¼š**
        ${{jobs.example-check.outputs.failed_examples}}
        
        ğŸ’¡ è¯·æŸ¥çœ‹CIè¯¦æƒ…é¡µé¢è·å–AIåˆ†æå’Œä¿®å¤å»ºè®®ã€‚

jobs:
  example-check:
    name: "Examples Inspection"
    runs-on:
      - "4-16Gi"
    image: alios-8u
    timeout: 5h
    retry:
      max: 1
      when:
        - runner_system_failure
    outputs:
      example_summary: ${{steps.run-checks.outputs.example_summary}}
      failed_examples: ${{steps.run-checks.outputs.failed_examples}}
    steps:
      - uses: checkout
      
      - uses: setup-env
        inputs:
          python-version: '3.10'
          node-version: '18'
          npm-version: '10'
          go-version: '1.24.3'
          
      - id: run-checks
        name: "Run Example Checks"
        run: |
          echo "ğŸ”§ Setting up Environment..."
          
          # Install Python Dependencies
          echo "ğŸ Setting up Python..."
          python -m pip install --upgrade pip
          python -m pip install -e ./python/
          python -m pip install pytest playwright python-dotenv langchain-openai langgraph langchain-core
          playwright install chromium || echo "âš ï¸ Playwright install failed"
          if [ -f "python/requirements.txt" ]; then
            python -m pip install -r python/requirements.txt
          fi
          
          # Install TypeScript Dependencies
          echo "ğŸ“œ Setting up TypeScript..."
          if [ "${{params.typescript}}" == "true" ]; then
            cd typescript
            npm ci
            npm run build
            npm link
            npm link wuying-agentbay-sdk
            npm install --no-save ts-node
            npx playwright install chromium || echo "âš ï¸ Playwright install failed"
            cd ..
          fi
          
          # Install Golang Dependencies
          echo "ğŸ¹ Setting up Golang..."
          if [ "${{params.golang}}" == "true" ]; then
            cd golang
            go env -w GOPROXY=https://goproxy.cn,direct
            go mod download
            go run github.com/playwright-community/playwright-go/cmd/playwright@latest install chromium || echo "âš ï¸ Playwright install failed"
            cd ..
          fi
          
          echo "ğŸš€ Starting Examples Inspection..."
          export AGENTBAY_API_KEY="${{secrets.AGENTBAY_API_KEY}}"
          export DASHSCOPE_API_KEY="${{secrets.DASHSCOPE_API_KEY}}"
          
          # Run checks sequentially but capture failures
          FAILED=false
          
          if [ "${{params.python}}" == "true" ]; then
            echo "=== Running Python Checks ==="
            set +e
            python scripts/check_examples.py --lang python
            if [ $? -ne 0 ]; then FAILED=true; fi
            set -e
          fi
          
          if [ "${{params.typescript}}" == "true" ]; then
            echo "=== Running TypeScript Checks ==="
            set +e
            python scripts/check_examples.py --lang typescript
            if [ $? -ne 0 ]; then FAILED=true; fi
            set -e
          fi
          
          if [ "${{params.golang}}" == "true" ]; then
            echo "=== Running Golang Checks ==="
            set +e
            python scripts/check_examples.py --lang golang
            if [ $? -ne 0 ]; then FAILED=true; fi
            set -e
          fi
          
          # Display report if exists and extract statistics
          if [ -f "example_check_report.md" ]; then
            echo ""
            echo "=========================================="
            echo "      Examples Inspection Report"
            echo "=========================================="
            echo ""
            cat example_check_report.md
            
            # Extract statistics for summary
            TOTAL_EXAMPLES=$(grep -o "[0-9]\+ Examples" example_check_report.md | grep -o "[0-9]\+" || echo "0")
            PASSED_EXAMPLES=$(grep -o "âœ… [0-9]\+ Passed" example_check_report.md | grep -o "[0-9]\+" || echo "0")
            FAILED_EXAMPLES=$(grep -o "âŒ [0-9]\+ Failed" example_check_report.md | grep -o "[0-9]\+" || echo "0")
            
            # Generate example summary for notification
            EXAMPLE_SUMMARY="$TOTAL_EXAMPLES Examples | âœ… $PASSED_EXAMPLES Passed | âŒ $FAILED_EXAMPLES Failed"
            
            # Extract failed example IDs for notification with language info
            if [ "$FAILED_EXAMPLES" -gt 0 ]; then
              # Extract failed examples with language detection
              FAILED_EXAMPLE_LIST=""
              grep -A1 "âŒ å¤±è´¥ç¤ºä¾‹" example_check_report.md | grep "ç¤ºä¾‹ID:" | head -10 | while IFS= read -r line; do
                example_id=$(echo "$line" | sed 's/ç¤ºä¾‹ID: //')
                
                # Detect language based on example ID patterns
                if echo "$example_id" | grep -q "golang\|\.go"; then
                  lang="Golang"
                elif echo "$example_id" | grep -q "python\|\.py"; then
                  lang="Python"
                elif echo "$example_id" | grep -q "typescript\|\.ts\|\.js"; then
                  lang="TypeScript"
                else
                  lang="æœªçŸ¥"
                fi
                
                # Clean up example ID
                clean_example_id=$(echo "$example_id" | sed -e 's/^.*\///' -e 's/^example_//')
                
                echo "- [$lang] $clean_example_id" >> /tmp/failed_examples_list
              done
              
              if [ -f /tmp/failed_examples_list ]; then
                FAILED_EXAMPLE_LIST=$(cat /tmp/failed_examples_list)
                rm -f /tmp/failed_examples_list
              fi
            else
              FAILED_EXAMPLE_LIST="âœ… æ‰€æœ‰ç¤ºä¾‹éƒ½é€šè¿‡äº†ï¼"
            fi
            
            # Output to step outputs for notification access
            echo "$EXAMPLE_SUMMARY" > "${{outputs.example_summary.path}}"
            printf "%s\n" "$FAILED_EXAMPLE_LIST" > "${{outputs.failed_examples.path}}"
            
            # Also append to CI summary
            cat example_check_report.md >> $AONE_CI_SUMMARY_MD
          else
            # No report generated
            echo "âš ï¸ ç¤ºä¾‹æ£€æŸ¥æŠ¥å‘Šæœªç”Ÿæˆ" > "${{outputs.example_summary.path}}"
            echo "æ— æ³•ç”Ÿæˆç¤ºä¾‹æ£€æŸ¥æŠ¥å‘Š" > "${{outputs.failed_examples.path}}"
          fi
          
          if [ "$FAILED" = "true" ]; then
            echo "âŒ One or more example checks failed."
            exit 1
          else
            echo "âœ… All enabled checks passed successfully."
            exit 0
          fi
          
      - id: display-example-results
        name: "Display Example Results"
        if: always()
        run: |
          echo "ğŸ” Debug: Checking for report files..."
          ls -la *report*.md || echo "No report files found"
          
          if [ -f "example_check_report.md" ]; then
            echo "âœ… Found example_check_report.md"
            echo "ğŸ“„ Report file size: $(wc -l < example_check_report.md) lines"
            echo "ğŸ“„ First 20 lines of report:"
            head -20 example_check_report.md
            echo "ğŸ“„ Last 20 lines of report:"
            tail -20 example_check_report.md
            echo "---"
            
            # Show success summary from the summary line
            if grep -q "Examples |" example_check_report.md; then
              SUMMARY_LINE=$(grep "Examples |" example_check_report.md | head -1)
              echo "ğŸ“Š $SUMMARY_LINE"
              echo ""
            fi
            
            # Create individual collapsible sections for each failed example - only show AI fix prompt
            if grep -q "âŒ" example_check_report.md || grep -q "å¤±è´¥" example_check_report.md; then
              echo "ğŸ“‹ å¤±è´¥ç¤ºä¾‹æ¦‚è§ˆï¼š"
              echo ""
              
              # Process each failed example and only show AI fix prompt in collapsible sections
              awk '
              BEGIN { 
                example_count = 0;
                in_example = 0;
                example_id = "";
                fix_prompt = "";
                current_section = "";
              }
              
              # Match various failure patterns
              /^âŒ/ || /å¤±è´¥/ || /FAILED/ || /ERROR/ {
                # If we have a previous example, output it
                if (example_count > 0 && example_id != "" && fix_prompt != "") {
                  print "::group::" example_count ". " example_id " - ğŸ› ï¸ AIä¿®å¤æç¤ºè¯";
                  print "```";
                  print fix_prompt;
                  print "```";
                  print "::endgroup::";
                  print "";
                }
                
                # Start new example
                example_count++;
                in_example = 1;
                example_id = $0;  # Use the whole line as ID initially
                fix_prompt = "";
                current_section = "";
                
                # Try to read next lines to find better ID
                while (getline > 0) {
                  if (/^ç¤ºä¾‹ID:/ || /^Example:/ || /^File:/ || /^æµ‹è¯•ID:/) {
                    gsub(/^[^:]*: */, "", $0);
                    example_id = $0;
                    break;
                  } else if (/^ğŸ› ï¸/ || /AIä¿®å¤/ || /ä¿®å¤æç¤º/ || /Fix/) {
                    current_section = "fix_prompt";
                    break;
                  } else if (/^---/ || /^===/ || /^$/) {
                    break;
                  }
                }
                next;
              }
              
              # AI fix prompt section markers
              /^ğŸ› ï¸/ || /AIä¿®å¤/ || /ä¿®å¤æç¤º/ || /Fix.*[Pp]rompt/ && in_example {
                current_section = "fix_prompt";
                next;
              }
              
              # Skip code block markers
              /^```/ && in_example {
                next;
              }
              
              # End of example section
              /^---/ || /^===/ || (/^$/ && current_section == "fix_prompt" && fix_prompt != "") {
                in_example = 0;
                current_section = "";
                next;
              }
              
              # Collect fix prompt content
              in_example && current_section == "fix_prompt" && $0 != "" {
                fix_prompt = fix_prompt $0 "\n";
              }
              
              END {
                # Output the last example if exists
                if (example_count > 0 && example_id != "" && fix_prompt != "") {
                  print "::group::" example_count ". " example_id " - ğŸ› ï¸ AIä¿®å¤æç¤ºè¯";
                  print "```";
                  print fix_prompt;
                  print "```";
                  print "::endgroup::";
                }
                
                # If no examples were found, show debug info
                if (example_count == 0) {
                  print "âš ï¸ æœªæ‰¾åˆ°å¤±è´¥ç¤ºä¾‹çš„AIä¿®å¤æç¤ºè¯";
                  print "è¯·æ£€æŸ¥æŠ¥å‘Šæ ¼å¼æ˜¯å¦æ­£ç¡®";
                }
              }
              ' example_check_report.md
              
            else
              echo "âœ… æ‰€æœ‰ç¤ºä¾‹éƒ½é€šè¿‡äº†ï¼"
            fi
          else
            echo "âŒ example_check_report.md ä¸å­˜åœ¨"
            echo "ğŸ” å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨ï¼š"
            ls -la
            echo "ğŸ” æŸ¥æ‰¾æ‰€æœ‰ .md æ–‡ä»¶ï¼š"
            find . -name "*.md" -type f 2>/dev/null || echo "æœªæ‰¾åˆ° .md æ–‡ä»¶"
          fi
