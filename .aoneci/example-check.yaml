name: "Multi-Language Examples Inspection"

triggers:
  # Manual trigger is implied, remove explicit manual config if it's invalid
  # schedule:
  #   - cron: "0 2 * * *"  # Run daily at 2:00 AM

params:
  python_enabled:
    name: Enable Python Examples
    type: boolean
    default: true
  typescript_enabled:
    name: Enable TypeScript Examples
    type: boolean
    default: true
  golang_enabled:
    name: Enable Golang Examples
    type: boolean
    default: true

jobs:
  python-example-check:
    name: "Python Examples Inspection"
    runs-on:
      - "4-16Gi"
    image: alios-8u
    timeout: 5h
    continue-on-error: true  # Continue pipeline even if this job fails
    retry:
      max: 1
      when:
        - runner_system_failure
    outputs:
      result: ${{ steps.run-python-check.outputs.result }}
    steps:
      - uses: checkout
      
      - uses: setup-env
        inputs:
          python-version: '3.10'
          
      - id: run-python-check
        name: "Run Python Examples Inspection"
        run: |
          if [ "${{params.python_enabled}}" != "true" ]; then
            echo "‚ö†Ô∏è Python examples check is disabled via parameters."
            echo "skipped" > "${{outputs.result.path}}"
            exit 0
          fi
          
          echo "üîß Setting up Python Environment..."
          python -m pip install --upgrade pip
          
          echo "üì¶ Installing Dependencies..."
          # Install SDK in editable mode
          python -m pip install -e ./python/
          
          # Install test & project dependencies
          python -m pip install pytest playwright python-dotenv
          
          # Install AI dependencies for analysis
          python -m pip install langchain-openai langgraph langchain-core
          
          # Install playwright browsers
          playwright install chromium || echo "‚ö†Ô∏è Playwright install failed"
          
          # Install extra requirements if they exist
          if [ -f "python/requirements.txt" ]; then
            python -m pip install -r python/requirements.txt
          fi
          
          echo "üìã Verifying Installed Packages..."
          python -m pip list | grep -E "agentbay|dotenv|langchain" || true
          
          echo "üöÄ Starting Python Examples Inspection..."
          export AGENTBAY_API_KEY="${{secrets.AGENTBAY_API_KEY}}"
          export DASHSCOPE_API_KEY="${{secrets.DASHSCOPE_API_KEY}}"
          
          set +e
          python scripts/check_examples.py --lang python
          EXIT_CODE=$?
          set -e
          
          if [ $EXIT_CODE -eq 0 ]; then
             echo "success" > "${{outputs.result.path}}"
             echo "‚úÖ Python check passed"
          else
             echo "failure" > "${{outputs.result.path}}"
             echo "‚ùå Python check failed"
             exit 1
          fi

  typescript-example-check:
    name: "TypeScript Examples Inspection"
    runs-on:
      - "4-16Gi"
    image: alios-8u
    timeout: 5h
    continue-on-error: true  # Continue pipeline even if this job fails
    retry:
      max: 1
      when:
        - runner_system_failure
    outputs:
      result: ${{ steps.run-typescript-check.outputs.result }}
    steps:
      - uses: checkout
      
      - uses: setup-env
        inputs:
          node-version: '18'
          npm-version: '10'
          
      - id: run-typescript-check
        name: "Run TypeScript Examples Inspection"
        run: |
          if [ "${{params.typescript_enabled}}" != "true" ]; then
             echo "‚ö†Ô∏è TypeScript examples check is disabled via parameters."
             echo "skipped" > "${{outputs.result.path}}"
             exit 0
          fi
          
          echo "üîß Setting up TypeScript Environment..."
          cd typescript
          npm ci
          npm run build
          
          # Link the package
          npm link
          npm link wuying-agentbay-sdk
          
          # Install dependencies
          npm install --no-save ts-node
          npx playwright install chromium || echo "‚ö†Ô∏è Playwright install failed"
          
          # Install Python AI dependencies for analysis runner
          echo "üì¶ Installing Python AI Dependencies..."
          python -m pip install langchain-openai langgraph langchain-core
          
          cd ..
          echo "üöÄ Starting TypeScript Examples Inspection..."
          export AGENTBAY_API_KEY="${{secrets.AGENTBAY_API_KEY}}"
          export DASHSCOPE_API_KEY="${{secrets.DASHSCOPE_API_KEY}}"
          
          set +e
          python scripts/check_examples.py --lang typescript
          EXIT_CODE=$?
          set -e
          
          if [ $EXIT_CODE -eq 0 ]; then
             echo "success" > "${{outputs.result.path}}"
             echo "‚úÖ TypeScript check passed"
          else
             echo "failure" > "${{outputs.result.path}}"
             echo "‚ùå TypeScript check failed"
             exit 1
          fi

  golang-example-check:
    name: "Golang Examples Inspection"
    runs-on:
      - "4-16Gi"
    image: alios-8u
    timeout: 5h
    continue-on-error: true  # Continue pipeline even if this job fails
    retry:
      max: 1
      when:
        - runner_system_failure
    outputs:
      result: ${{ steps.run-golang-check.outputs.result }}
    steps:
      - uses: checkout
      
      - uses: setup-env
        inputs:
          go-version: '1.24.3'
          
      - id: run-golang-check
        name: "Run Golang Examples Inspection"
        run: |
          if [ "${{params.golang_enabled}}" != "true" ]; then
             echo "‚ö†Ô∏è Golang examples check is disabled via parameters."
             echo "skipped" > "${{outputs.result.path}}"
             exit 0
          fi

          echo "üîß Setting up Golang Environment..."
          cd golang
          go env -w GOPROXY=https://goproxy.cn,direct
          go mod download
          
          # Install playwright
          go run github.com/playwright-community/playwright-go/cmd/playwright@latest install chromium || echo "‚ö†Ô∏è Playwright install failed"
          
          cd ..
          # Install Python AI dependencies for analysis runner
          echo "üì¶ Installing Python AI Dependencies..."
          python -m pip install langchain-openai langgraph langchain-core
          
          echo "üöÄ Starting Golang Examples Inspection..."
          export AGENTBAY_API_KEY="${{secrets.AGENTBAY_API_KEY}}"
          export DASHSCOPE_API_KEY="${{secrets.DASHSCOPE_API_KEY}}"
          
          set +e
          python scripts/check_examples.py --lang golang
          EXIT_CODE=$?
          set -e
          
          if [ $EXIT_CODE -eq 0 ]; then
             echo "success" > "${{outputs.result.path}}"
             echo "‚úÖ Golang check passed"
          else
             echo "failure" > "${{outputs.result.path}}"
             echo "‚ùå Golang check failed"
             exit 1
          fi

  summary:
    name: "Examples Inspection Summary"
    needs: ["python-example-check", "typescript-example-check", "golang-example-check"]
    # Ensure summary runs even if previous jobs failed
    if: always()
    runs-on:
      - "4-16Gi"
    steps:
      - run: |
          echo "=========================================="
          echo "      Examples Inspection Completed"
          echo "=========================================="
          echo ""
          
          # Check outputs of each job
          PYTHON_RES="${{needs.python-example-check.outputs.result}}"
          TS_RES="${{needs.typescript-example-check.outputs.result}}"
          GO_RES="${{needs.golang-example-check.outputs.result}}"
          
          echo "Python Check Result: $PYTHON_RES"
          echo "TypeScript Check Result: $TS_RES"
          echo "Golang Check Result: $GO_RES"
          
          # Fail the summary job if any critical check failed
          if [ "$PYTHON_RES" == "failure" ] || [ "$TS_RES" == "failure" ] || [ "$GO_RES" == "failure" ]; then
            echo "‚ùå One or more example checks failed."
            
            # Display the report content if available (it might be on the runner, 
            # but since jobs run on different runners, we can't easily access the file directly 
            # unless we use artifacts. Ideally we should use artifacts, but for now relying on logs)
            echo "Please check the logs of the failed jobs for the detailed report and AI analysis."
            exit 1
          fi
          
          echo "‚úÖ All enabled checks passed successfully."
