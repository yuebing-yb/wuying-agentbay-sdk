# agentbay SDK Multi-Language CI/CD Pipeline
name: "agentbay SDK Multi-Language Quality Assurance"

triggers:
  merge_request:
    types:
      - opened
      - reopened
    target-branches:
      - "**"

# Strategy configuration to prevent jobs from being accidentally cancelled
strategy:
  cancel-in-progress: false
  fail-fast: false

params:
  python_enabled:
    name: Enable Python Testing
    type: boolean
    default: true
  typescript_enabled:
    name: Enable TypeScript Testing
    type: boolean
    default: true
  golang_enabled:
    name: Enable Golang Testing
    type: boolean
    default: true
  docs_check_enabled:
    name: Enable Documentation Quality Check
    type: boolean
    default: true
  runs_on_resources:
    name: Resource Specification
    description: "Runtime container resource specification"
    default: "4-16Gi"
    options:
      - "4-16Gi"
      - "8-32Gi"
      - "16-64Gi"

jobs:
  # Documentation quality check job
  docs-quality-check:
    continue-on-error: false
    name: "Documentation Quality Check"
    when: "${{params.docs_check_enabled}}"
    runs-on:
      - "${{params.runs_on_resources}}"
    image: alios-8u
    timeout: 30m
    retry:
      max: 2
      when:
        - runner_system_failure
        - stuck_or_timeout_failure
    steps:
      - uses: checkout
      - uses: setup-env
        inputs:
          python-version: '3.10'
      
      - id: emoji-anchor-check
        name: "VS Code Emoji Anchor Compatibility Check"
        when: "${{params.docs_check_enabled}}"
        run: |
          echo "üîç Checking emoji anchor compatibility for VS Code..."
          
          # Check for emoji anchor compatibility issues
          python scripts/check_markdown_links.py \
            --warn-emoji-anchors \
            --verbose \
            --strict
          
          # Check the exit code of the previous command
          if [ $? -ne 0 ]; then
            echo "‚ùå Found broken links! Failing the pipeline."
            exit 1
          fi
          
          echo "‚úÖ Emoji anchor compatibility check completed"

  # Python testing job
  python-lint-test:
    name: "Python Code Quality Check"
    when: "${{params.python_enabled}}"
    runs-on:
      - "${{params.runs_on_resources}}"
    image: alios-8u
    timeout: 1h
    retry:
      max: 2
      when:
        - runner_system_failure
        - stuck_or_timeout_failure
    steps:

      - uses: checkout
      - uses: setup-env
        inputs:
          python-version: '3.10'
          pip-cache: true
      
      - id: python-lint
        continue-on-error: true
        name: "Python Code Format Check & Security Check"
        when: "${{params.python_enabled}}"
        run: |
          cd python
          python -m pip install --upgrade pip
          # Install tools for linting
          pip install black isort flake8 mypy bandit pip-audit
          pip install types-requests types-aiohttp types-Pillow types-setuptools types-pydantic || true
          # Run all checks
          black agentbay tests --check --diff
          echo "Format check completed"
          isort --check-only --diff --verbose agentbay tests
          echo "Quality check completed"
          flake8 agentbay tests --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=agentbay/modules/browser/eval
          echo "Flake8 check completed"
          mypy agentbay --install-types --no-error-summary --install-types --non-interactive
          echo "Type check completed"
          python -m bandit -r agentbay/ -v --skip B105,B106,B107
          echo "Bandit scan completed"
          echo "Executing pip-audit dependency vulnerability scan..."
          pip-audit --desc
          echo "Dependency vulnerability scan completed"

  # TypeScript testing job
  typescript-lint-test:
    name: "TypeScript Code Quality Check & Security Check"
    when: "${{params.typescript_enabled}}"
    image: alios-8u
    runs-on:
      - "${{params.runs_on_resources}}"
    retry:
      max: 2
      when:
        - runner_system_failure
        - stuck_or_timeout_failure
    steps:
      - uses: checkout
      - uses: setup-env
        inputs:
          node-version: "18"
          tnpm-version: "10"
          tnpm-cache: true
        
      - id: typescript-lint
        continue-on-error: true
        name: "TypeScript Code Format Check"
        when: "${{params.typescript_enabled}}"
        run: |
          cd typescript
          # Set tnpm timeout and retry strategy
          # Only install lint-related packages for better performance
          tnpm install --prefer-offline --no-audit \
            eslint@8.35.0 \
            @typescript-eslint/eslint-plugin@5.54.0 \
            @typescript-eslint/parser@5.54.0 \
            typescript@4.9.5
          # Run lint using fallback script
          node scripts/run_with_fallback.js eslint eslint@8.35.0 "src/**/*.ts"
      

  # Golang testing job
  golang-lint-test:
    name: "Golang Code Quality Check & Security Check"
    when: "${{params.golang_enabled}}"
    image: alios-8u
    runs-on:
      - "${{params.runs_on_resources}}"
    retry:
      max: 2
      when:
        - runner_system_failure
        - stuck_or_timeout_failure
    steps:
      
      - uses: checkout
      - uses: setup-env
        inputs:
          go-version: "1.24.3"
          go-mod-cache: true
          go-cache: true
      
      - id: golang-lint
        continue-on-error: true
        name: "Golang Code Format Check"
        when: "${{params.golang_enabled}}"
        run: |
          # Configure Go environment
          cd golang
          # Download dependencies (use go-mod-cache from setup-env)
          go mod download
          go mod verify
          # Run basic checks that don't require additional tools
          echo "Building code..."
          go build -v ./api/client/... || echo "Build completed with warnings"
          echo "Running go vet..."
          go vet ./...
          # Run go fmt check (non-destructive)
          echo "Checking code formatting..."
          UNFORMATTED=$(gofmt -l . | grep -v "api/client" || true)
          if [ -n "$UNFORMATTED" ]; then
            echo "The following files need formatting:"
            echo "$UNFORMATTED"
          else
            echo "All files are properly formatted"
          fi
      

  summary:
    name: "Multi-Language Quality Check Summary"
    needs: ["docs-quality-check", "python-lint-test", "typescript-lint-test", "golang-lint-test"]
    runs-on:
      - "4-16Gi"
    steps:
      - run: |
          echo "=========================================="
          echo "    agentbay SDK Multi-Language Quality Check Summary"
          echo "=========================================="
          echo ""
          echo "All prerequisite jobs have completed successfully!"
          echo ""
          echo "‚úÖ Documentation Quality Check: PASSED"
          echo "‚úÖ Python Lint: PASSED"
          echo "‚úÖ TypeScript Lint: PASSED"
          echo "‚úÖ Golang Lint: PASSED"
          echo ""
          echo "=========================================="
          echo "‚úÖ All Quality Checks: PASSED"
          echo "=========================================="