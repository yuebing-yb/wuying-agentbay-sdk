name: "Smart Integration Test"

params:
  test_type:
    name: Test Type
    type: string
    default: "all"
    options:
      - "all"
      - "python"
      - "typescript"
      - "golang"

jobs:
  smart-integration-test:
    name: "Smart Integration Test"
    runs-on:
      - "4-16Gi"
    image: alios-8u
    timeout: 3h
    retry:
      max: 2
      when:
        - runner_system_failure
        - stuck_or_timeout_failure
    steps:
      - uses: checkout
      
      - uses: setup-env
        inputs:
          python-version: '3.12'
          
      - id: run-smart-tests
        name: "Run Smart Tests"
        run: |
          echo "üîÑ Installing dependencies for Smart Test Runner..."
          
          # Install Go if needed for golang or all test types
          if [ "${{params.test_type}}" = "golang" ] || [ "${{params.test_type}}" = "all" ]; then
            echo "üêπ Installing Go environment..."
            # Check if Go is already available
            if ! command -v go &> /dev/null; then
              # Download and install Go 1.21 to local directory
              mkdir -p $HOME/go-install
              cd $HOME/go-install
              if [ ! -f go1.24.3.linux-amd64.tar.gz ]; then
                echo "üì• Downloading Go 1.24.3 from mirror..."
                # Try multiple mirrors for better connectivity in China
                wget -O go1.24.3.linux-amd64.tar.gz https://golang.google.cn/dl/go1.24.3.linux-amd64.tar.gz || \
                wget -O go1.24.3.linux-amd64.tar.gz https://mirrors.aliyun.com/golang/go1.24.3.linux-amd64.tar.gz || \
                wget -O go1.24.3.linux-amd64.tar.gz https://go.dev/dl/go1.24.3.linux-amd64.tar.gz
              fi
              if [ -f go1.24.3.linux-amd64.tar.gz ]; then
                echo "üì¶ Extracting Go 1.24.3..."
                tar -xzf go1.24.3.linux-amd64.tar.gz
                export PATH=$HOME/go-install/go/bin:$PATH
                export GOROOT=$HOME/go-install/go
                # Set Go proxy immediately after installation
                export GOPROXY=https://goproxy.cn,direct
                export GOSUMDB=sum.golang.google.cn
                export GOTOOLCHAIN=local
                echo "‚úÖ Go installed to local directory"
              else
                echo "‚ùå Failed to download Go"
              fi
              cd $(pwd)
            fi
            go version || echo "‚ùå Go installation failed"
            
            # Setup Golang dependencies
            if command -v go &> /dev/null && [ -d "golang" ]; then
              echo "üì¶ Setting up Golang dependencies..."
              # Set Go proxy to use faster mirror in China
              export GOPROXY=https://goproxy.cn,direct
              export GOSUMDB=sum.golang.google.cn
              cd golang
              go mod download
              # Install Playwright browsers for Golang tests
              echo "üé≠ Installing Playwright browsers for Golang..."
              go run github.com/playwright-community/playwright-go/cmd/playwright@latest install --with-deps
              cd .. || echo "‚ö†Ô∏è Go setup failed"
            fi
          fi
          
          # Install Node.js if needed for typescript or all test types
          if [ "${{params.test_type}}" = "typescript" ] || [ "${{params.test_type}}" = "all" ]; then
            echo "üìú Installing Node.js environment..."
            # Check if Node.js is already available
            if ! command -v node &> /dev/null; then
              # Install Node.js using NodeSource binary distribution (no sudo required)
              mkdir -p $HOME/nodejs
              cd $HOME/nodejs
              if [ ! -f node-v18.18.0-linux-x64.tar.xz ]; then
                echo "üì• Downloading Node.js from mirror..."
                # Try multiple mirrors for better connectivity in China
                wget -O node-v18.18.0-linux-x64.tar.xz https://npmmirror.com/mirrors/node/v18.18.0/node-v18.18.0-linux-x64.tar.xz || \
                wget -O node-v18.18.0-linux-x64.tar.xz https://mirrors.aliyun.com/nodejs-release/v18.18.0/node-v18.18.0-linux-x64.tar.xz || \
                wget -O node-v18.18.0-linux-x64.tar.xz https://nodejs.org/dist/v18.18.0/node-v18.18.0-linux-x64.tar.xz
              fi
              if [ -f node-v18.18.0-linux-x64.tar.xz ]; then
                echo "üì¶ Extracting Node.js..."
                tar -xf node-v18.18.0-linux-x64.tar.xz
                export PATH=$HOME/nodejs/node-v18.18.0-linux-x64/bin:$PATH
                echo "‚úÖ Node.js installed to local directory"
              else
                echo "‚ùå Failed to download Node.js"
              fi
              cd $(pwd)
            fi
            node --version || echo "‚ùå Node.js installation failed"
            npm --version || echo "‚ùå npm installation failed"
            
            # Setup TypeScript dependencies
            if command -v npm &> /dev/null && [ -d "typescript" ]; then
              echo "üì¶ Setting up TypeScript dependencies..."
              # Set npm registry to use faster mirror in China
              npm config set registry https://registry.npmmirror.com
              cd typescript
              # Clean install to ensure fresh dependencies
              echo "üßπ Cleaning npm cache and node_modules..."
              npm cache clean --force || true
              rm -rf node_modules package-lock.json || true
              
              # Show package.json devDependencies for debugging
              echo "üìã Checking package.json devDependencies..."
              cat package.json | grep -A 20 '"devDependencies"' || echo "‚ö†Ô∏è No devDependencies found"
              
              # Install all dependencies including dev dependencies needed for testing
              echo "üì¶ Installing npm dependencies..."
              npm install --verbose
              
              # Verify ts-jest installation
              echo "üîç Verifying ts-jest installation..."
              npm list ts-jest || echo "‚ö†Ô∏è ts-jest not found in npm list"
              
              # Check if ts-jest exists in node_modules
              echo "üìÇ Checking node_modules for ts-jest..."
              ls -la node_modules/ | grep ts-jest || echo "‚ö†Ô∏è ts-jest not found in node_modules"
              
              # Try to require ts-jest
              echo "üîç Testing ts-jest require..."
              node -e "try { require('ts-jest'); console.log('‚úÖ ts-jest can be required'); } catch(e) { console.log('‚ùå ts-jest require failed:', e.message); }"
              
              # If still not found, install explicitly
              if ! npm list ts-jest > /dev/null 2>&1; then
                echo "‚ö†Ô∏è ts-jest not found, installing explicitly..."
                npm install --save-dev ts-jest @types/jest typescript jest
                npm list ts-jest
              fi
              
              # Install Playwright browsers for TypeScript tests
              echo "üé≠ Installing Playwright browsers for TypeScript..."
              npx playwright install --with-deps || echo "‚ö†Ô∏è Playwright install failed"
              cd .. || echo "‚ö†Ô∏è TypeScript setup failed"
            fi
          fi
          
          # Setup Python environment (always needed for the test runner itself)
          python -m pip config set global.timeout 600
          python -m pip config set global.retries 5
          python -m pip install --upgrade pip
          
          # Install Python dependencies similar to unit test job
          pip install "darabonba-core>=1.0.0,<2.0.0" \
                      "alibabacloud-tea-openapi>=0.4.0rc3" \
                      "cryptography>=44.0.0" \
                      "httpx>=0.28.1" \
                      "alibabacloud-tea-util>=0.3.13" \
                      "python-dotenv>=1.0.0" \
                      "pydantic>=2.0" \
                      "playwright>=1.5.0" \
                      "loguru>=0.7.0"
          
          # Install test dependencies
          pip install pytest pytest-cov pytest-asyncio
          
          # Install AI dependencies
          pip install langchain-openai langgraph langchain-core
          
          echo "üîß Setting up environment..."
          # Ensure we're in the correct working directory
          cd /aoneci/runner/work/source || exit 1
          echo "üìÇ Current working directory: $(pwd)"
          
          # Install SDK in editable mode with correct path
          if [ -d "python" ]; then
            pip install -e ./python/
            echo "‚úÖ Python SDK installed successfully"
          else
            echo "‚ùå Python directory not found"
            ls -la
            exit 1
          fi
          
          # Set PYTHONPATH similar to unit test job
          export PYTHONPATH="${PYTHONPATH}:$(pwd)/python"
          export AGENTBAY_API_KEY="${{secrets.AGENTBAY_API_KEY}}"
          export DASHSCOPE_API_KEY="${{secrets.DASHSCOPE_API_KEY}}"
          
          echo "üöÄ Starting Smart Test Runner..."
          echo "Working directory: $(pwd)"
          echo "Python path: $PYTHONPATH"
          
          # Set up PATH for installed tools
          if [ "${{params.test_type}}" = "golang" ] || [ "${{params.test_type}}" = "all" ]; then
            export PATH=$HOME/go-install/go/bin:$PATH
            export GOROOT=$HOME/go-install/go
            export GOPROXY=https://goproxy.cn,direct
            export GOSUMDB=sum.golang.google.cn
            export GOTOOLCHAIN=local
            echo "üîç Checking Go installation..."
            which go || echo "‚ùå Go not found in PATH"
            go version || echo "‚ùå Go version check failed"
          fi
          
          if [ "${{params.test_type}}" = "typescript" ] || [ "${{params.test_type}}" = "all" ]; then
            export PATH=$HOME/nodejs/node-v18.18.0-linux-x64/bin:$PATH
            echo "üîç Checking Node.js installation..."
            which node || echo "‚ùå Node not found in PATH"
            node --version || echo "‚ùå Node version check failed"
            which npm || echo "‚ùå npm not found in PATH"
            npm --version || echo "‚ùå npm version check failed"
          fi
          
          # Run the smart test runner and capture exit code with updated PATH
          # Ensure we have the correct working directory
          cd /aoneci/runner/work/source || exit 1
          
          # Set up comprehensive PATH with all installed tools
          export PATH="$HOME/go-install/go/bin:$HOME/nodejs/node-v18.18.0-linux-x64/bin:$PATH"
          
          # Set Go environment variables for China network
          export GOPROXY=https://goproxy.cn,direct
          export GOSUMDB=sum.golang.google.cn  
          export GOTOOLCHAIN=local
          
          if python scripts/smart_test_runner.py --test-type="${{params.test_type}}"; then
            echo "‚úÖ Smart Test Runner completed successfully"
            
            # Check if test report was generated
          if [ -f "test_report.md" ]; then
            echo "‚úÖ Test report generated successfully"
            
            # Display in CI Summary (Markdown format)
            echo "## ü§ñ Smart Integration Test Report" >> $AONE_CI_SUMMARY_MD
            echo "" >> $AONE_CI_SUMMARY_MD
            cat test_report.md >> $AONE_CI_SUMMARY_MD
            
            # Also show in console for immediate viewing
            echo "üìã Test report preview:"
            head -50 test_report.md
            
            # Archive as build artifact
            mkdir -p artifacts
            cp test_report.md artifacts/smart_test_report.md
          else
            echo "‚ö†Ô∏è No test report generated"
            echo "## ‚ùå Smart Integration Test Report" >> $AONE_CI_SUMMARY_MD
            echo "No test report was generated. Check the logs above for errors." >> $AONE_CI_SUMMARY_MD
          fi
          else
            echo "‚ùå Smart Test Runner failed with exit code $?"
            echo "‚ùå CI pipeline will now fail"
            exit 1
          fi

