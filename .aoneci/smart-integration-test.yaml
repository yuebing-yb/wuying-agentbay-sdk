name: "Smart Integration Test"

params:
  test_type:
    name: Test Type
    type: string
    default: "all"
    options:
      - "all"
      - "python"
      - "typescript"
      - "golang"

jobs:
  smart-integration-test:
    name: "Smart Integration Test"
    runs-on:
      - "4-16Gi"
    image: alios-8u
    timeout: 1h
    retry:
      max: 2
      when:
        - runner_system_failure
        - stuck_or_timeout_failure
    steps:
      - uses: checkout
      
      - uses: setup-env
        inputs:
          python-version: '3.12'
          
      - id: install-dependencies
        name: "Install Dependencies"
        run: |
          echo "ğŸ”§ Installing Python dependencies..."
          python -m pip install --upgrade pip
          
          echo "ğŸ“¦ Installing core dependencies..."
          python -m pip install pytest
          
          echo "ğŸ“¦ Installing LangChain dependencies..."
          python -m pip install langchain-openai langgraph langchain-core
          
          echo "ğŸ“¦ Installing Alibaba Cloud dependencies..."
          python -m pip install alibabacloud_tea_openapi alibabacloud_credentials alibabacloud_tea_util alibabacloud_endpoint_util
          
          echo "ğŸ“¦ Installing SDK in editable mode..."
          python -m pip install -e python/
          
          echo "âœ… Verifying installations..."
          echo "ğŸ” Checking installed langchain packages..."
          pip show langchain-openai
          pip show langgraph  
          pip show langchain-core
          
          echo "ğŸ” Trying different import methods..."
          python -c "import sys; print('Python paths:'); [print(p) for p in sys.path]"
          python -c "import pkgutil; print('Available packages:'); [print(name) for _, name, _ in pkgutil.iter_modules() if 'langchain' in name]"
          
          echo "ğŸ“‹ Installed packages:"
          pip list | grep -E "(langchain|langgraph)"
          
      - id: run-smart-tests
        name: "Run Smart Tests"
        run: |
          echo "Starting Smart Test Runner..."
          export PYTHONPATH="${PYTHONPATH}:$(pwd)/python"
          export AGENTBAY_API_KEY="${{secrets.AGENTBAY_API_KEY}}"
          export DASHSCOPE_API_KEY="${{secrets.DASHSCOPE_API_KEY}}"
          
          # Run the smart test runner and capture exit code
          if python scripts/smart_test_runner.py --test-type="${{params.test_type}}"; then
            echo "âœ… Smart Test Runner completed successfully"
            
            # Check if test report was generated
            if [ -f "test_report.md" ]; then
              echo "âœ… Test report generated successfully"
              echo "ğŸ“‹ Test report content:"
              cat test_report.md
            else
              echo "âš ï¸ No test report generated"
            fi
          else
            echo "âŒ Smart Test Runner failed with exit code $?"
            echo "âŒ CI pipeline will now fail"
            exit 1
          fi

