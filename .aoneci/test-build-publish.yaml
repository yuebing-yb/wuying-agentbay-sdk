name: Test Build and Upload

triggers:
  push:
    branches:
      - main

params:
  python-version:
    name: "Python Version"
    type: string
    required: false
    options:
      - "3.10"
      - "3.11"
      - "3.12"
    description: Python version for building PyPI package
    default: "3.10"
  
  repository-url:
    name: "Custom Repository URL"
    advanced: true
    type: string
    required: false
    default: "http://opsx.vip.tbsite.net/aliyun-pypi/simple/"
    description: "Upload repository URL, fill in when uploading to custom repository. Default upload to artlab"
  node-version:
    name: "Node.js Version"
    type: string
    required: false
    options:
      - "18"
      - "20"
    description: Node.js version for building npm package
    default: "20"
  
  java-version:
    name: "Java Version"
    type: string
    required: false
    options:
      - "8"
      - "11"
      - "17"
      - "21"
    description: Java version for building Maven package
    default: "17"
  
  maven-version:
    name: "Maven Version"
    type: string
    required: false
    default: "3.9"
    description: Maven version for building Java package

jobs:
  pypi-build:
    image: alios-8u
    outputs:
      string-output: ${{steps.modify-version.outputs.env}}
    steps:
      - uses: checkout
      - uses: setup-env
        inputs:
          python-version: ${{params.python-version}}
      - id: rm-dist
        run: |
          cd python
          if [ -d "dist" ]; then
              rm -rf dist/
          fi
      - id: modify-version
        run: |
          cd python
          echo "Modifying version number and package name..."
          BASE_VERSION=$(grep "version = " pyproject.toml | head -n 1 | cut -d '"' -f 2)
          echo "BASE_VERSION=${BASE_VERSION}" > $AONE_CI_WORKSPACE/BASE_VERSION
          TIMESTAMP=$(TZ='Asia/Shanghai' date "+%Y%m%d%H%M%S")
          FINAL_VERSION="${BASE_VERSION}.${TIMESTAMP}"
          echo "FINAL_VERSION=${FINAL_VERSION}" > $AONE_CI_WORKSPACE/FINAL_VERSION
          echo "${FINAL_VERSION}" > ${{outputs.env.path}}
          cat $AONE_CI_WORKSPACE/BASE_VERSION
          cat $AONE_CI_WORKSPACE/FINAL_VERSION
          sed -i "s/version = .*/version = \"${FINAL_VERSION}\"/" pyproject.toml
          sed -i 's/wuying-agentbay-sdk/wuying-agentbay-sdk-test/g' pyproject.toml
          cat pyproject.toml | grep name
          grep "version" pyproject.toml
      
      - id: pypi-install--build-publish
        run: | 
          cd python
          echo "Installing dependencies..."
          python -m pip install --upgrade pip
          pip install twine build poetry
          echo "Building PyPI package..."
          cat $AONE_CI_WORKSPACE/FINAL_VERSION
          # Check if build module can be imported
          echo $FINAL_VERSION_ENV
          python -c "import build; print('‚úÖ Build module available, version:', build.__version__)" || (echo "‚ùå Build module import failed" && exit 1)
          # Build using poetry
          poetry build
          echo "Files to upload:"
          ls -la dist/
          echo "Uploading PyPI package..."
          twine --version
          twine upload --repository-url ${{params.repository-url}} --username ${{secrets.username}} --password ${{secrets.password}} dist/*
          echo "‚úÖ Upload completed"
  
  npm-build:
    image: alios-8u
    outputs:
      string-output: ${{steps.modify-version.outputs.env}}
    steps:
      - uses: checkout
      - uses: setup-env
        inputs:
          node-version: ${{params.node-version}}
          npm-cache: false
      
      - id: rm-dist
        run: |
          cd typescript
          if [ -d "dist" ]; then
            rm -rf dist/
          fi
      
      - id: modify-version
        run: |
          cd typescript
          echo "Modifying version number and package name..."
          
          # Read current version number
          CURRENT_NAME=$(jq -r '.name' package.json)
          BASE_VERSION=$(jq -r '.version' package.json)
          echo "Original package name: $CURRENT_NAME"
          echo "Original version number: $BASE_VERSION"
          
          echo "BASE_VERSION=${BASE_VERSION}" > $AONE_CI_WORKSPACE/BASE_VERSION
          TIMESTAMP=$(TZ='Asia/Shanghai' date "+%Y%m%d%H%M%S")
          FINAL_VERSION="$BASE_VERSION-beta.$TIMESTAMP"
          echo "FINAL_VERSION=${FINAL_VERSION}" > $AONE_CI_WORKSPACE/FINAL_VERSION
          echo "${FINAL_VERSION}" > ${{outputs.env.path}}
          
          cat $AONE_CI_WORKSPACE/BASE_VERSION
          cat $AONE_CI_WORKSPACE/FINAL_VERSION
          
          # Modify package name to internal scope
          NEW_PACKAGE_NAME="test-wuying-agentbay-sdk"
          echo "NEW_PACKAGE_NAME=$NEW_PACKAGE_NAME"
          
          # Update package.json, add publishConfig
          jq ".name = \"$NEW_PACKAGE_NAME\" | .version = \"$FINAL_VERSION\" | .publishConfig = {\"registry\": \"https://registry.npmjs.org\"}" package.json > package_temp.json
          mv package_temp.json package.json
          
          echo "Modified package information:"
          jq '{name, version, publishConfig}' package.json
         

      - id: tnmp-install-build-publish
        run: | 
          set -e
          cd typescript
          echo "Installing dependencies and building with npm..."
          
          # Install dependencies using npm
          npm install
          
          echo "Building TypeScript package..."
          npm run build
          
          echo "Build artifacts:"
          ls -la dist/

          echo "üîê Configuring NPM authentication..."
          
          # Check if NPM_TOKEN exists
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "‚ùå Error: NPM_TOKEN not configured"
            echo "Please configure secrets.NPM_TOKEN in CI system"
            exit 1
          fi
          
          # Create .npmrc file - using safer approach
          {
            printf "//registry.npmjs.org/:_authToken=%s\n" "${{ secrets.NPM_TOKEN }}"
            printf "registry=https://registry.npmjs.org/\n"
            printf "always-auth=true\n"
          } > ~/.npmrc
          
          # Verify configuration
          echo "üìã Verifying NPM configuration..."
          npm whoami
          grep -v "_authToken" ~/.npmrc || true
          
          # Test authentication
          echo "üîç Testing NPM authentication..."
          
          echo "‚úÖ NPM authentication configuration completed"
          echo "Publishing to NPM registry..."
          npm publish --access public
          
          echo "‚úÖ Publishing completed"
          
  go-build:
    outputs:
      string-output: ${{steps.generate_instructions.outputs.env}}
    name: golang release
    runs-on: 2-8Gi
    timeout: 20m

    steps:
      - uses: checkout
      - uses: setup-env
        inputs:
          go_version: "1.23.2"
          go_mod_cache: true
          go_cache: true
      
      - id: get_commit
        run: |
          git fetch --all --tags
          
          # Ê∑ªÂä†Ë∞ÉËØï‰ø°ÊÅØ
          echo "=== Git Debug Information ==="
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Current branch: $CURRENT_BRANCH"
          echo "Git remote URL: $(git remote get-url origin)"
          
          # È™åËØÅÂàÜÊîØ
          if [[ "$CURRENT_BRANCH" != "main" ]]; then
            echo "‚ùå Warning: CI/CD running on unexpected branch: $CURRENT_BRANCH"
            echo "Expected: main "
          fi
          
          COMMIT_SHA=$(git rev-parse --short=12 HEAD)
          FULL_COMMIT_SHA=$(git rev-parse HEAD)
          
          echo "Short commit SHA: $COMMIT_SHA"
          echo "Full commit SHA: $FULL_COMMIT_SHA"
          echo "Commit message: $(git log -1 --pretty=format:'%s')"
          echo "Commit author: $(git log -1 --pretty=format:'%an <%ae>')"
          echo "Commit date: $(git log -1 --pretty=format:'%ci')"  
          echo "COMMIT_SHA=$(git rev-parse --short=12 HEAD)" >> $AONE_CI_ENV
          echo "FULL_COMMIT_SHA=$FULL_COMMIT_SHA" >> $AONE_CI_ENV
          echo "BRANCH_NAME=$CURRENT_BRANCH" >> $AONE_CI_ENV
          echo "================================"
      
      - id: validate_module
        run: |
          echo "Validating Go module configuration..."
          cd golang
          echo "Current directory: $(pwd)"
          echo "Checking go.mod file:"
          cat go.mod | head -5
      - id: generate_instructions
        run: |
          # Get commit time and hash (using UTC time to ensure consistency with Git)
          COMMIT_DATE=$(git show -s --format=%ct $COMMIT_SHA)
          
          # È™åËØÅÊó∂Èó¥Êà≥Ëé∑ÂèñÊòØÂê¶Ê≠£Á°Æ
          echo "=== Go Module Debug Information ==="
          echo "Commit SHA used: $COMMIT_SHA"
          echo "Commit date (timestamp): $COMMIT_DATE"
          echo "Commit date (human): $(date -u -d @$COMMIT_DATE '+%Y-%m-%d %H:%M:%S UTC')"
          
          # Á°Æ‰øù‰ΩøÁî®Ê≠£Á°ÆÁöÑÊó∂Èó¥Ê†ºÂºèÁîüÊàê pseudo version
          if [ -z "$COMMIT_DATE" ] || [ "$COMMIT_DATE" = "0" ]; then
            echo "‚ùå Error: Failed to get commit timestamp"
            exit 1
          fi
          
          # ‰ΩøÁî® Git ÁöÑÊ†áÂáÜÊñπÂºèÁîüÊàêÊó∂Èó¥Êà≥ÔºåÁ°Æ‰øù‰∏é Go Ê®°ÂùóÁ≥ªÁªü‰∏ÄËá¥
          COMMIT_TIME_UTC=$(git show -s --format=%ct $COMMIT_SHA)
          FORMATTED_TIME=$(date -u -d @$COMMIT_TIME_UTC '+%Y%m%d%H%M%S')
          PSEUDO_VERSION="v0.0.0-${FORMATTED_TIME}-$COMMIT_SHA"
          
          echo "Generated pseudo version: $PSEUDO_VERSION"
          echo "Time components breakdown:"
          echo "  - Raw timestamp: $COMMIT_TIME_UTC"
          echo "  - Formatted time: $FORMATTED_TIME"
          echo "  - Commit SHA: $COMMIT_SHA"
          
          # È™åËØÅÁîüÊàêÁöÑÁâàÊú¨Ê†ºÂºè
          if [[ ! "$PSEUDO_VERSION" =~ ^v0\.0\.0-[0-9]{14}-[a-f0-9]{12}$ ]]; then
            echo "‚ùå Error: Invalid pseudo version format: $PSEUDO_VERSION"
            echo "Expected format: v0.0.0-yyyymmddhhmmss-abcdefabcdef"
            exit 1
          fi
          
          # ÊØîËæÉ‰∏éÂΩìÂâçÊó∂Èó¥ÁöÑÂ∑ÆÂºÇÔºåÊ£ÄÊµãÂºÇÂ∏∏
          CURRENT_TIME=$(date +%s)
          TIME_DIFF=$((CURRENT_TIME - COMMIT_TIME_UTC))
          echo "Time difference from now: ${TIME_DIFF} seconds ($(($TIME_DIFF / 3600)) hours)"
          
          if [ $TIME_DIFF -lt 0 ]; then
            echo "‚ö†Ô∏è  Warning: Commit time is in the future! This may cause Go module issues."
          fi
          
          # Test if the commit is accessible via Go modules
          echo "Testing Go module accessibility..."
          echo "Repository URL: code.alibaba-inc.com/InnoArchClub/wuying-agentbay-sdk.git/golang"
          
          # ËÆæÁΩÆ Go ÁéØÂ¢É‰ª•ËÆøÈóÆÁßÅÊúâ‰ªìÂ∫ì
          export GOPRIVATE="code.alibaba-inc.com/*"
          export GOPROXY="direct"
          export GOSUMDB="off"
          
          echo "Go environment:"
          echo "  GOPRIVATE=$GOPRIVATE"
          echo "  GOPROXY=$GOPROXY"
          echo "  GOSUMDB=$GOSUMDB"
          
          # Check if we can list the module at this version
          echo "Testing module access with generated version..."
            
          # Â∞ùËØï‰ΩøÁî®‰∏çÂêåÁöÑÊó∂Èó¥Ê†ºÂºè
          echo "Trying alternative timestamp formats..."
          
          # Â∞ùËØïÊú¨Âú∞Êó∂Âå∫Êó∂Èó¥
          LOCAL_TIME=$(git show -s --format=%ct $COMMIT_SHA)
          ALT_FORMATTED_TIME=$(date -d @$LOCAL_TIME '+%Y%m%d%H%M%S')
          ALT_PSEUDO_VERSION="v0.0.0-${ALT_FORMATTED_TIME}-$COMMIT_SHA"
          echo "Alternative version (local time): $ALT_PSEUDO_VERSION"
          
          if timeout 15 go list -m "code.alibaba-inc.com/InnoArchClub/wuying-agentbay-sdk.git/golang@$ALT_PSEUDO_VERSION" 2>/dev/null; then
            echo "‚úÖ Alternative version works, using local time"
            PSEUDO_VERSION="$ALT_PSEUDO_VERSION"
          fi
          
          # ÊúÄÁªàÈ™åËØÅÔºöÂ∞ùËØïÁõ¥Êé•ÂÖãÈöÜÊåáÂÆö commit
          echo "Final verification: Testing direct commit access..."
          TEMP_DIR=$(mktemp -d)
          
          echo "=================================="
          echo "Final pseudo version: $PSEUDO_VERSION"
          echo "${PSEUDO_VERSION}" > ${{outputs.env.path}}

  java-build:
    image: alios-8u
    outputs:
      string-output: ${{steps.java-build.outputs.env}}
    steps:
      - uses: checkout
      - uses: setup-env
        inputs:
          java-version: ${{params.java-version}}
          maven-version: ${{params.maven-version}}
      
      - id: check-maven-settings
        run: |
          echo "=== Checking Maven Settings ==="
          ls -la ~
          echo "directory finally"
          if [ -f ~/.m2/settings.xml ]; then
            echo "‚úÖ Found settings.xml in ~/.m2/"
            ls -la ~/.m2/settings.xml
          else
            echo "‚ùå No settings.xml found in ~/.m2/"
            echo "üìÅ Contents of ~/.m2/ directory:"
            ls -la ~/.m2/ || echo "~/.m2/ directory does not exist"
          fi
          echo ""
      
      - id: java-build
        run: |
          cd java
          cd agentbay
          echo "check java version"
          echo "=== Java Version Check ==="
          java -version 2>&1 | head -3
          echo ""
          echo "=== Maven Version Check ==="
          mvn -version | head -3
          echo ""
          echo "=== Javac Version Check ==="
          javac -version 2>&1
          echo "starting maven deploy"
          mvn deploy -DskipTests
          
          # Get version information for output
          JAVA_VERSION=$(mvn help:evaluate "-Dexpression=project.version" -q "-DforceStdout")
          echo "Java package version: $JAVA_VERSION"
          echo "${JAVA_VERSION}" > ${{outputs.env.path}}
  summary:
    continue-on-error: true
    needs: [pypi-build, npm-build, go-build, java-build]
    steps:
      - run: |
          # Get commit time and hash (using UTC time to ensure consistency with Git)
          echo "${{jobs.go-build.outputs.string-output}}"
          
          cat <<EOF >> $AONE_CI_SUMMARY_MD
          # Wuying AgentBay SDK Multi-Language Release Summary

          ## Build Information
          - **Source Branch**: ${{git.branch}}
          - **Git Commit**: ${{git.commitId}}
          - **Build Timestamp**: $(date '+%Y-%m-%d %H:%M:%S')

          ## üêç Python Package
          ### Installation Command
          \`\`\`bash
          pip install -i http://yum.tbsite.net/aliyun-pypi/simple/ --trusted-host yum.tbsite.net wuying-agentbay-sdk-test==${{jobs.pypi-build.outputs.string-output}}
          \`\`\`

          ## üì¶ TypeScript/npm Package
          ### Installation Command
          \`\`\`bash
          npm install test-wuying-agentbay-sdk@${{jobs.npm-build.outputs.string-output}}
          \`\`\`

          ## üöÄ Go Module Development Version
          ### Basic Information
          - **Module Path**: github.com/aliyun/wuying-agentbay-sdk/golang
          - **Internal Repository**: code.alibaba-inc.com/InnoArchClub/wuying-agentbay-sdk.git/golang
          - **Pseudo Version**: ${{jobs.go-build.outputs.string-output}}
          - **Commit Hash**: ${{git.commitId}}

          ### Installation Command
          \`\`\`bash
          go mod edit -replace github.com/aliyun/wuying-agentbay-sdk/golang=code.alibaba-inc.com/InnoArchClub/wuying-agentbay-sdk.git/golang@${{jobs.go-build.outputs.string-output}}
          go mod tidy
          \`\`\`

          ### Cleanup Command (After Testing)
          \`\`\`bash
          go mod edit -dropreplace github.com/aliyun/wuying-agentbay-sdk/golang
          go mod tidy
          \`\`\`

          ## ‚òï Java/Maven Package
          ### Basic Information
          - **Package Version**: ${{jobs.java-build.outputs.string-output}}
          - **Build Status**: Successfully deployed to Maven repository

          ### Usage
          Add the following dependency to your `pom.xml`:
          \`\`\`xml
          <dependency>
              <groupId>com.alibaba</groupId>
              <artifactId>agentbay-sdk</artifactId>
              <version>${{jobs.java-build.outputs.string-output}}</version>
          </dependency>
          \`\`\`

          ## Important Notes
          - **Python**: Use the internal PyPI repository for installation
          - **TypeScript/npm**: Package published to NPM registry with test prefix
          - **Go**: Ensure your Git client can access the internal repository
          - **Go**: Remember to execute the cleanup command after testing is complete
          - **Java**: Package deployed to Maven repository, add dependency to your pom.xml

          ---
          **‚úÖ All four language SDKs have been successfully built and published!**
          EOF

          echo "=========================================="
          echo "      Wuying AgentBay SDK Multi-Language Release Completed"
          echo "=========================================="
          echo ""
          echo "üìã Summary has been generated in markdown format"