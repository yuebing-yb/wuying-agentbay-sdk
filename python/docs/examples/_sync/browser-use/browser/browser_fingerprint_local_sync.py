# DO NOT EDIT THIS FILE MANUALLY.
# This file is auto-generated from the _async directory.

"""
Example demonstrating Browser Fingerprint local sync feature with AgentBay SDK.

This example shows how to sync local browser fingerprint to remote browser fingerprint.
BrowserFingerprintGenerator has ability to dump local installed chrome browser fingerprint,
and then you can sync it to remote browser fingerprint by using BrowserOption.fingerprint_format.

This example will:
1. Generate local chrome browser fingerprint by BrowserFingerprintGenerator
2. Sync local browser fingerprint to remote browser fingerprint
3. Verify remote browser fingerprint
4. Clean up session
"""

import os
from agentbay import AgentBay
from agentbay import CreateSessionParams
from agentbay import BrowserOption
from agentbay import BrowserFingerprintGenerator

from playwright.sync_api import sync_playwright


def main():
    """Main function demonstrating browser fingerprint basic usage."""
    # Get API key from environment variable
    api_key = os.getenv("AGENTBAY_API_KEY")
    if not api_key:
        print("Error: AGENTBAY_API_KEY environment variable not set")
        return

    # Initialize AgentBay client
    print("Initializing AgentBay client...")
    agent_bay = AgentBay(api_key=api_key)

    # Create a session
    print("Creating a new session...")
    params = CreateSessionParams(
        image_id="browser_latest",
    )
    session_result = agent_bay.create(params)

    if session_result.success:
        session = session_result.session
        print(f"Session created with ID: {session.session_id}")

        fingerprint_generator = BrowserFingerprintGenerator()
        fingerprint_format = fingerprint_generator.generate_fingerprint()

        # Create browser option with fingerprint format.
        # Fingerprint format is dumped from local chrome browser by BrowserFingerprintGenerator
        # automatically, you can use it to sync to remote browser fingerprint.
        browser_option = BrowserOption(
            use_stealth=True,
            fingerprint_format=fingerprint_format
        )

        if session.browser.initialize(browser_option):
            endpoint_url = session.browser.get_endpoint_url()
            print("endpoint_url =", endpoint_url)

            with sync_playwright() as p:
                browser = p.chromium.connect_over_cdp(endpoint_url)
                context = browser.contexts[0]
                page = context.new_page()
                
                # Check user agent.
                print("\n--- Check User Agent ---")
                page.goto("https://httpbin.org/user-agent")
                
                # Wait for page to load completely
                page.wait_for_load_state("networkidle")

                # Get the response text more safely
                try:
                    response_text = page.evaluate("() => document.body.innerText.trim()")
                    print(f"Raw response: {response_text}")
                    
                    import json
                    response = json.loads(response_text)
                    user_agent = response.get("user-agent", "")
                    print(f"User Agent: {user_agent}")
                except json.JSONDecodeError as e:
                    print(f"Failed to parse JSON response: {e}")
                    print(f"Raw response content: {response_text}")
                    # Fallback: try to get user agent directly
                    user_agent = page.evaluate("() => navigator.userAgent")
                    print(f"Fallback User Agent: {user_agent}")
                except Exception as e:
                    print(f"Error getting user agent: {e}")
                    user_agent = page.evaluate("() => navigator.userAgent")
                    print(f"Fallback User Agent: {user_agent}")

                print("Please check if User Agent is synced correctly by visiting https://httpbin.org/user-agent in local chrome browser.")

                page.wait_for_timeout(3000)
                browser.close()

        # Clean up session
        agent_bay.delete(session)
    

if __name__ == "__main__":
    main()