# DO NOT EDIT THIS FILE MANUALLY.
# This file is auto-generated from the _async directory.

"""
Example demonstrating AIBrowser capabilites with AgentBay SDK.
This example shows how to use AIBrowser to solve captcha automatically, including:
- Create AIBrowser session
- Use playwright to connect to AIBrowser instance through CDP protocol
- Set solve_captchas to be True and goto tongcheng website
- We will encounter a captcha and we will solve it automatically.
"""

import os
import time
import base64

from agentbay import AgentBay
from agentbay import CreateSessionParams
from agentbay import BrowserOption

from playwright.sync_api import sync_playwright

from agentbay import (
    Browser,
    BrowserOption,
    BrowserViewport,
    BrowserScreen,
    BrowserFingerprint,
    BrowserProxy
)

# Polling detection function, continuously checks until condition is met or timeout
def wait_for_condition(page, condition_code, timeout=30000, interval=200):
    """Polling detection function, continuously checks until condition is met or timeout"""
    start_time = time.time()
    while time.time() - start_time < timeout / 1000:  # timeout is in milliseconds, convert to seconds
        try:
            result = page.evaluate(condition_code)
            if result:
                return True
        except Exception:
            # Ignore errors, continue polling
            pass
        time.sleep(interval / 1000)  # interval is in milliseconds, convert to seconds
    return False

def main():
    # Get API key from environment variable
    api_key = os.getenv("AGENTBAY_API_KEY")
    if not api_key:
        print("Error: AGENTBAY_API_KEY environment variable not set")
        return

    # Initialize AgentBay client
    print("Initializing AgentBay client...")
    agent_bay = AgentBay(api_key=api_key)

    # Create a session
    print("Creating a new session...")
    params = CreateSessionParams(
        image_id="browser_latest",  # Specify the image ID
    )
    session_result = agent_bay.create(params)

    if session_result.success:
        session = session_result.session
        print(f"Session created with ID: {session.session_id}")

        browser_option = BrowserOption(
            use_stealth=True,
            solve_captchas=True,
        )
        if session.browser.initialize(browser_option):
            print("Browser initialized successfully")
            endpoint_url = session.browser.get_endpoint_url()
            print("endpoint_url =", endpoint_url)

            with sync_playwright() as p:
                browser = p.chromium.connect_over_cdp(endpoint_url)
                context = browser.contexts[0]
                page = context.new_page()
                print("üåê Navigating to tongcheng site...")
                url = "https://passport.ly.com/Passport/GetPassword"
                page.goto(url, wait_until="domcontentloaded")

                # Use selector to locate input field
                input_element = page.wait_for_selector('#name_in', timeout=10000)
                print("Found login name input field: #name_in")

                # Clear input field and enter phone number
                phone_number = "15011556760"
                print(f"Entering phone number: {phone_number}")

                input_element.click()
                input_element.fill("")  # Clear input field
                input_element.type(phone_number)
                print("Waiting for captcha")

                # Wait a moment to ensure input is complete
                time.sleep(1)

                print("Clicking next step button...")
                page.click('#next_step1')

                # Listen for console messages
                def handle_console(msg):
                    print(f"üîç Received console message: {msg.text}")
                    if msg.text == "wuying-captcha-solving-started":
                        print("üéØ Captcha processing started")
                        asyncio.create_task(page.evaluate("window.captchaSolvingStarted = true; window.captchaSolvingFinished = false;"))
                    elif msg.text == "wuying-captcha-solving-finished":
                        print("‚úÖ Captcha processing finished")
                        asyncio.create_task(page.evaluate("window.captchaSolvingFinished = true;"))

                page.on("console", handle_console)

                # wait for 1 second
                time.sleep(1)
                
                started = wait_for_condition(
                    page,
                    "() => window.captchaSolvingStarted === true",
                    3000,
                    200
                )
                
                if started:
                    print("üéØ Detected captcha processing started, waiting for completion...")
                    finished = wait_for_condition(
                        page,
                        "() => window.captchaSolvingFinished === true",
                        30000,
                        200
                    )
                    if finished:
                        print("‚úÖ Captcha processing completed")
                    else:
                        print("‚ö†Ô∏è Captcha processing timeout, may still be in progress, continuing execution")
                else:
                    print("‚è≠Ô∏è No captcha processing detected, may not need to handle captcha")

                time.sleep(2)
                print("Test completed")

                # Keep browser open for a while to observe results
                time.sleep(5)

                # Take screenshot and print base64, can be pasted directly into Chrome address bar
                try:
                    screenshot_bytes = page.screenshot(full_page=False)
                    b64 = base64.b64encode(screenshot_bytes).decode("utf-8")
                    print("page_screenshot_base64 = data:image/png;base64,", b64)
                except Exception as e:
                    print("screenshot failed:", e)

                browser.close()

if __name__ == "__main__":
    main()
