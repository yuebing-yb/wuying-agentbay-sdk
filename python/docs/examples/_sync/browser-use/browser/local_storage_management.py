# DO NOT EDIT THIS FILE MANUALLY.
# This file is auto-generated from the _async directory.

"""
Example demonstrating browser local storage management with AgentBay SDK.

This example shows how to:
- Get items from local storage
- Set items in local storage
- Remove items from local storage
- Clear all local storage
- Work with session storage
- Persist data across page reloads
"""

import os
import json

from agentbay import AgentBay
from agentbay import CreateSessionParams
from agentbay import BrowserOption

from playwright.sync_api import sync_playwright


def get_local_storage(page) -> dict:
    """Get all items from local storage."""
    print("\nüì¶ Getting all local storage items...")
    
    storage_data = page.evaluate("""
        () => {
            const items = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                items[key] = localStorage.getItem(key);
            }
            return items;
        }
    """)
    
    print(f"‚úÖ Found {len(storage_data)} items in local storage")
    for key, value in storage_data.items():
        print(f"   - {key}: {value[:50]}...")
    
    return storage_data


def set_local_storage_item(page, key: str, value: str):
    """Set an item in local storage."""
    print(f"\nüíæ Setting local storage item: {key}")
    
    page.evaluate(f"""
        () => {{
            localStorage.setItem('{key}', '{value}');
        }}
    """)
    
    print(f"‚úÖ Item set successfully")


def remove_local_storage_item(page, key: str):
    """Remove an item from local storage."""
    print(f"\nüóëÔ∏è  Removing local storage item: {key}")
    
    page.evaluate(f"""
        () => {{
            localStorage.removeItem('{key}');
        }}
    """)
    
    print(f"‚úÖ Item removed successfully")


def clear_local_storage(page):
    """Clear all local storage."""
    print("\nüóëÔ∏è  Clearing all local storage...")
    
    page.evaluate("() => { localStorage.clear(); }")
    
    print("‚úÖ Local storage cleared")


def get_session_storage(page) -> dict:
    """Get all items from session storage."""
    print("\nüì¶ Getting all session storage items...")
    
    storage_data = page.evaluate("""
        () => {
            const items = {};
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                items[key] = sessionStorage.getItem(key);
            }
            return items;
        }
    """)
    
    print(f"‚úÖ Found {len(storage_data)} items in session storage")
    return storage_data


def set_session_storage_item(page, key: str, value: str):
    """Set an item in session storage."""
    print(f"\nüíæ Setting session storage item: {key}")
    
    page.evaluate(f"""
        () => {{
            sessionStorage.setItem('{key}', '{value}');
        }}
    """)
    
    print(f"‚úÖ Item set successfully")


def demonstrate_persistence(page):
    """Demonstrate local storage persistence across page reloads."""
    print("\nüîÑ Demonstrating local storage persistence...")
    
    # Set some data
    test_data = {
        "user_name": "test_user",
        "preferences": json.dumps({"theme": "dark", "language": "en"}),
        "last_visit": "2024-01-01"
    }
    
    for key, value in test_data.items():
        set_local_storage_item(page, key, value)
    
    print("\n  Reloading page...")
    page.reload()
    page.wait_for_load_state("networkidle")
    
    # Check if data persists
    storage_after_reload = get_local_storage(page)
    
    all_persisted = all(key in storage_after_reload for key in test_data.keys())
    
    if all_persisted:
        print("‚úÖ All data persisted after reload")
    else:
        print("‚ùå Some data was lost after reload")


def store_complex_data(page):
    """Store and retrieve complex data structures."""
    print("\nüóÇÔ∏è  Storing complex data structures...")
    
    complex_data = {
        "user": {
            "id": 12345,
            "name": "John Doe",
            "email": "john@example.com",
            "preferences": {
                "theme": "dark",
                "notifications": True,
                "language": "en"
            }
        },
        "cart": [
            {"id": 1, "name": "Product A", "quantity": 2},
            {"id": 2, "name": "Product B", "quantity": 1}
        ]
    }
    
    # Store as JSON string
    json_data = json.dumps(complex_data)
    set_local_storage_item(page, "app_data", json_data)
    
    # Retrieve and parse
    retrieved_data = page.evaluate("""
        () => {
            const data = localStorage.getItem('app_data');
            return data ? JSON.parse(data) : null;
        }
    """)
    
    if retrieved_data:
        print("‚úÖ Complex data stored and retrieved successfully")
        print(f"   User: {retrieved_data['user']['name']}")
        print(f"   Cart items: {len(retrieved_data['cart'])}")
    else:
        print("‚ùå Failed to retrieve complex data")


def main():
    """Main function demonstrating local storage management."""
    api_key = os.getenv("AGENTBAY_API_KEY")
    if not api_key:
        print("‚ùå Error: AGENTBAY_API_KEY environment variable not set")
        return
    
    agent_bay = AgentBay(api_key=api_key)
    session = None
    
    try:
        print("=" * 60)
        print("Browser Local Storage Management Example")
        print("=" * 60)
        
        # Create browser session
        print("\nCreating browser session...")
        params = CreateSessionParams(image_id="browser_latest")
        result = agent_bay.create(params)
        
        if not result.success or not result.session:
            print(f"‚ùå Failed to create session: {result.error_message}")
            return
        
        session = result.session
        print(f"‚úÖ Session created: {session.session_id}")
        
        # Initialize browser
        browser_option = BrowserOption()
        if not session.browser.initialize(browser_option):
            print("‚ùå Failed to initialize browser")
            return
        
        print("‚úÖ Browser initialized")
        
        # Get browser endpoint
        endpoint_url = session.browser.get_endpoint_url()
        
        with sync_playwright() as p:
            browser = p.chromium.connect_over_cdp(endpoint_url)
            context = browser.contexts[0]
            page = context.new_page()
            
            # Navigate to a website
            page.goto("https://example.com")
            page.wait_for_load_state("networkidle")
            
            # Example 1: Basic local storage operations
            print("\n" + "=" * 60)
            print("Example 1: Basic Local Storage Operations")
            print("=" * 60)
            
            set_local_storage_item(page, "test_key", "test_value")
            set_local_storage_item(page, "user_id", "12345")
            set_local_storage_item(page, "session_token", "abc123xyz")
            
            get_local_storage(page)
            
            # Example 2: Remove specific item
            print("\n" + "=" * 60)
            print("Example 2: Remove Specific Item")
            print("=" * 60)
            
            remove_local_storage_item(page, "test_key")
            get_local_storage(page)
            
            # Example 3: Session storage
            print("\n" + "=" * 60)
            print("Example 3: Session Storage")
            print("=" * 60)
            
            set_session_storage_item(page, "temp_data", "temporary_value")
            get_session_storage(page)
            
            # Example 4: Complex data storage
            print("\n" + "=" * 60)
            print("Example 4: Complex Data Storage")
            print("=" * 60)
            
            store_complex_data(page)
            
            # Example 5: Persistence demonstration
            print("\n" + "=" * 60)
            print("Example 5: Persistence Demonstration")
            print("=" * 60)
            
            demonstrate_persistence(page)
            
            # Example 6: Clear all storage
            print("\n" + "=" * 60)
            print("Example 6: Clear All Storage")
            print("=" * 60)
            
            clear_local_storage(page)
            get_local_storage(page)
            
            browser.close()
        
        print("\n‚úÖ Local storage management examples completed")
        
    except Exception as e:
        print(f"\n‚ùå Error: {e}")
        
    finally:
        if session:
            print("\nüßπ Cleaning up session...")
            agent_bay.delete(session)
            print("‚úÖ Session deleted")


if __name__ == "__main__":
    main()

