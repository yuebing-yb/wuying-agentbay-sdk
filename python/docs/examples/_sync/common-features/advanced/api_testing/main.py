# DO NOT EDIT THIS FILE MANUALLY.
# This file is auto-generated from the _async directory.

"""
Example demonstrating API testing with AgentBay SDK.

This example shows how to:
- Test REST API endpoints
- Validate API responses
- Test different HTTP methods
- Handle API authentication
- Test API error handling
- Perform load testing
"""

import os
import json
from typing import Dict, Any

from agentbay import AgentBay
from agentbay.session_params import CreateSessionParams


def test_get_request(session, url: str) -> Dict[str, Any]:
    """Test a GET request."""
    print(f"\nüîç Testing GET request: {url}")
    
    command = f"curl -s -w '\\n%{{http_code}}' '{url}'"
    result = session.command.execute_command(command)
    
    if result.success:
        lines = result.output.strip().split('\n')
        status_code = lines[-1]
        response_body = '\n'.join(lines[:-1])
        
        print(f"‚úÖ Status Code: {status_code}")
        print(f"   Response: {response_body[:100]}...")
        
        return {
            "success": True,
            "status_code": status_code,
            "body": response_body
        }
    else:
        print(f"‚ùå Request failed: {result.error_message}")
        return {"success": False, "error": result.error_message}


def test_post_request(session, url: str, data: Dict[str, Any]) -> Dict[str, Any]:
    """Test a POST request."""
    print(f"\nüì§ Testing POST request: {url}")
    
    json_data = json.dumps(data)
    command = f"curl -s -X POST -H 'Content-Type: application/json' -d '{json_data}' -w '\\n%{{http_code}}' '{url}'"
    
    result = session.command.execute_command(command)
    
    if result.success:
        lines = result.output.strip().split('\n')
        status_code = lines[-1]
        response_body = '\n'.join(lines[:-1])
        
        print(f"‚úÖ Status Code: {status_code}")
        print(f"   Response: {response_body[:100]}...")
        
        return {
            "success": True,
            "status_code": status_code,
            "body": response_body
        }
    else:
        print(f"‚ùå Request failed: {result.error_message}")
        return {"success": False, "error": result.error_message}


def test_put_request(session, url: str, data: Dict[str, Any]) -> Dict[str, Any]:
    """Test a PUT request."""
    print(f"\nüîÑ Testing PUT request: {url}")
    
    json_data = json.dumps(data)
    command = f"curl -s -X PUT -H 'Content-Type: application/json' -d '{json_data}' -w '\\n%{{http_code}}' '{url}'"
    
    result = session.command.execute_command(command)
    
    if result.success:
        lines = result.output.strip().split('\n')
        status_code = lines[-1]
        
        print(f"‚úÖ Status Code: {status_code}")
        return {"success": True, "status_code": status_code}
    else:
        print(f"‚ùå Request failed: {result.error_message}")
        return {"success": False, "error": result.error_message}


def test_delete_request(session, url: str) -> Dict[str, Any]:
    """Test a DELETE request."""
    print(f"\nüóëÔ∏è  Testing DELETE request: {url}")
    
    command = f"curl -s -X DELETE -w '\\n%{{http_code}}' '{url}'"
    result = session.command.execute_command(command)
    
    if result.success:
        lines = result.output.strip().split('\n')
        status_code = lines[-1]
        
        print(f"‚úÖ Status Code: {status_code}")
        return {"success": True, "status_code": status_code}
    else:
        print(f"‚ùå Request failed: {result.error_message}")
        return {"success": False, "error": result.error_message}


def test_api_with_auth(session, url: str, token: str) -> Dict[str, Any]:
    """Test API with authentication."""
    print(f"\nüîê Testing authenticated request: {url}")
    
    command = f"curl -s -H 'Authorization: Bearer {token}' -w '\\n%{{http_code}}' '{url}'"
    result = session.command.execute_command(command)
    
    if result.success:
        lines = result.output.strip().split('\n')
        status_code = lines[-1]
        
        print(f"‚úÖ Status Code: {status_code}")
        return {"success": True, "status_code": status_code}
    else:
        print(f"‚ùå Request failed: {result.error_message}")
        return {"success": False, "error": result.error_message}


def validate_json_response(response_body: str, expected_fields: list) -> bool:
    """Validate JSON response structure."""
    print("\n‚úì Validating JSON response...")
    
    try:
        data = json.loads(response_body)
        
        missing_fields = [field for field in expected_fields if field not in data]
        
        if missing_fields:
            print(f"‚ùå Missing fields: {missing_fields}")
            return False
        
        print(f"‚úÖ All expected fields present: {expected_fields}")
        return True
        
    except json.JSONDecodeError:
        print("‚ùå Invalid JSON response")
        return False


def perform_load_test(session, url: str, num_requests: int = 10):
    """Perform simple load testing."""
    print(f"\n‚ö° Performing load test: {num_requests} requests to {url}")
    
    tasks = []
    for i in range(num_requests):
        tasks.append(test_get_request(session, url))
    
    results = asyncio.gather(*tasks, return_exceptions=True)
    
    successful = sum(1 for r in results if isinstance(r, dict) and r.get("success"))
    failed = num_requests - successful
    
    print(f"\nüìä Load Test Results:")
    print(f"   Total Requests: {num_requests}")
    print(f"   Successful: {successful}")
    print(f"   Failed: {failed}")
    print(f"   Success Rate: {(successful/num_requests)*100:.1f}%")


def main():
    """Main function demonstrating API testing."""
    api_key = os.getenv("AGENTBAY_API_KEY")
    if not api_key:
        print("‚ùå Error: AGENTBAY_API_KEY environment variable not set")
        return
    
    agent_bay = AgentBay(api_key=api_key)
    session = None
    
    try:
        print("=" * 60)
        print("API Testing Example")
        print("=" * 60)
        
        # Create session
        print("\nCreating session...")
        params = CreateSessionParams(image_id="linux_latest")
        result = agent_bay.create(params)
        
        if not result.success or not result.session:
            print(f"‚ùå Failed to create session: {result.error_message}")
            return
        
        session = result.session
        print(f"‚úÖ Session created: {session.session_id}")
        
        # Test public API endpoints
        test_api_url = "https://jsonplaceholder.typicode.com"
        
        # Example 1: Test GET request
        print("\n" + "=" * 60)
        print("Example 1: GET Request")
        print("=" * 60)
        
        get_result = test_get_request(session, f"{test_api_url}/posts/1")
        
        if get_result.get("success"):
            validate_json_response(
                get_result["body"],
                ["userId", "id", "title", "body"]
            )
        
        # Example 2: Test POST request
        print("\n" + "=" * 60)
        print("Example 2: POST Request")
        print("=" * 60)
        
        post_data = {
            "title": "Test Post",
            "body": "This is a test post",
            "userId": 1
        }
        
        test_post_request(session, f"{test_api_url}/posts", post_data)
        
        # Example 3: Test PUT request
        print("\n" + "=" * 60)
        print("Example 3: PUT Request")
        print("=" * 60)
        
        put_data = {
            "id": 1,
            "title": "Updated Post",
            "body": "This is an updated post",
            "userId": 1
        }
        
        test_put_request(session, f"{test_api_url}/posts/1", put_data)
        
        # Example 4: Test DELETE request
        print("\n" + "=" * 60)
        print("Example 4: DELETE Request")
        print("=" * 60)
        
        test_delete_request(session, f"{test_api_url}/posts/1")
        
        # Example 5: Load testing
        print("\n" + "=" * 60)
        print("Example 5: Load Testing")
        print("=" * 60)
        
        perform_load_test(session, f"{test_api_url}/posts/1", num_requests=5)
        
        print("\n‚úÖ API testing examples completed")
        
    except Exception as e:
        print(f"\n‚ùå Error: {e}")
        
    finally:
        if session:
            print("\nüßπ Cleaning up session...")
            agent_bay.delete(session)
            print("‚úÖ Session deleted")


if __name__ == "__main__":
    main()

