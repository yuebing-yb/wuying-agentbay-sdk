import time
# DO NOT EDIT THIS FILE MANUALLY.
# This file is auto-generated from the _async directory.

"""
Example demonstrating multi-session management with AgentBay SDK.

This example shows how to:
- Manage multiple sessions with different configurations
- Switch between sessions
- Share data between sessions
- Monitor session states
- Coordinate operations across sessions
"""

import os
from typing import Dict, Any, List

from agentbay import AgentBay
from agentbay import CreateSessionParams


class SessionManager:
    """Manager for multiple AgentBay sessions."""
    
    def __init__(self, agent_bay: AgentBay):
        self.agent_bay = agent_bay
        self.sessions: Dict[str, Any] = {}
        self.session_metadata: Dict[str, Dict[str, Any]] = {}
    
    def create_session(self, name: str, image_id: str, labels: Dict[str, str] = None):
        """Create and register a new session."""
        print(f"Creating session '{name}' with image '{image_id}'...")
        
        params = CreateSessionParams(
            image_id=image_id,
            labels=labels or {"name": name}
        )
        
        result = self.agent_bay.create(params)
        
        if result.success and result.session:
            self.sessions[name] = result.session
            self.session_metadata[name] = {
                "session_id": result.session.session_id,
                "image_id": image_id,
                "created_at": time.time(),
                "labels": labels or {}
            }
            print(f"‚úÖ Session '{name}' created: {result.session.session_id}")
            return result.session
        else:
            print(f"‚ùå Failed to create session '{name}': {result.error_message}")
            return None
    
    def get_session(self, name: str):
        """Get a session by name."""
        return self.sessions.get(name)
    
    def list_sessions(self) -> List[str]:
        """List all managed session names."""
        return list(self.sessions.keys())
    
    def execute_on_session(self, name: str, command: str):
        """Execute a command on a specific session."""
        session = self.get_session(name)
        if not session:
            print(f"‚ùå Session '{name}' not found")
            return None
        
        result = session.command.execute_command(command)
        if result.success:
            print(f"‚úÖ [{name}] Command executed: {result.output.strip()[:50]}")
            return result.output
        else:
            print(f"‚ùå [{name}] Command failed: {result.error_message}")
            return None
    
    def transfer_file_between_sessions(
        self,
        source_name: str,
        dest_name: str,
        file_path: str
    ):
        """Transfer a file from one session to another."""
        source_session = self.get_session(source_name)
        dest_session = self.get_session(dest_name)
        
        if not source_session or not dest_session:
            print("‚ùå Source or destination session not found")
            return False
        
        print(f"Transferring file '{file_path}' from '{source_name}' to '{dest_name}'...")
        
        # Read from source
        read_result = source_session.file_system.read_file(file_path)
        if not read_result.success:
            print(f"‚ùå Failed to read from source: {read_result.error_message}")
            return False
        
        # Write to destination
        write_result = dest_session.file_system.write_file(file_path, read_result.content)
        if not write_result.success:
            print(f"‚ùå Failed to write to destination: {write_result.error_message}")
            return False
        
        print(f"‚úÖ File transferred successfully")
        return True
    
    def cleanup(self):
        """Clean up all managed sessions."""
        print(f"\nüßπ Cleaning up {len(self.sessions)} sessions...")
        
        for name, session in self.sessions.items():
            try:
                result = self.agent_bay.delete(session)
                if result.success:
                    print(f"‚úÖ Session '{name}' deleted")
                else:
                    print(f"‚ùå Failed to delete session '{name}': {result.error_message}")
            except Exception as e:
                print(f"‚ùå Error deleting session '{name}': {e}")
        
        self.sessions.clear()
        self.session_metadata.clear()


def main():
    """Main function demonstrating multi-session management."""
    api_key = os.getenv("AGENTBAY_API_KEY")
    if not api_key:
        print("‚ùå Error: AGENTBAY_API_KEY environment variable not set")
        return
    
    agent_bay = AgentBay(api_key=api_key)
    manager = SessionManager(agent_bay)
    
    try:
        print("=" * 60)
        print("Multi-Session Management Example")
        print("=" * 60)
        
        # Create multiple sessions with different configurations
        manager.create_session(
            "dev-session",
            "linux_latest",
            {"environment": "development", "purpose": "testing"}
        )
        
        manager.create_session(
            "prod-session",
            "linux_latest",
            {"environment": "production", "purpose": "deployment"}
        )
        
        manager.create_session(
            "test-session",
            "linux_latest",
            {"environment": "testing", "purpose": "qa"}
        )
        
        print(f"\nüìã Active sessions: {manager.list_sessions()}")
        
        # Execute commands on different sessions
        print("\n" + "=" * 60)
        print("Executing Commands on Different Sessions")
        print("=" * 60)
        
        manager.execute_on_session("dev-session", "echo 'Development environment'")
        manager.execute_on_session("prod-session", "echo 'Production environment'")
        manager.execute_on_session("test-session", "echo 'Testing environment'")
        
        # Create a file in one session
        print("\n" + "=" * 60)
        print("File Transfer Between Sessions")
        print("=" * 60)
        
        dev_session = manager.get_session("dev-session")
        if dev_session:
            content = "This is a shared configuration file"
            write_result = dev_session.file_system.write_file("/tmp/config.txt", content)
            if write_result.success:
                print("‚úÖ File created in dev-session")
                
                # Transfer to other sessions
                manager.transfer_file_between_sessions(
                    "dev-session",
                    "prod-session",
                    "/tmp/config.txt"
                )
                
                manager.transfer_file_between_sessions(
                    "dev-session",
                    "test-session",
                    "/tmp/config.txt"
                )
        
        # Verify file exists in all sessions
        print("\n" + "=" * 60)
        print("Verifying File in All Sessions")
        print("=" * 60)
        
        for session_name in manager.list_sessions():
            manager.execute_on_session(session_name, "cat /tmp/config.txt")
        
        print("\n‚úÖ Multi-session management example completed")
        
    except Exception as e:
        print(f"\n‚ùå Error in main: {e}")
        
    finally:
        manager.cleanup()


if __name__ == "__main__":
    main()

