# DO NOT EDIT THIS FILE MANUALLY.
# This file is auto-generated from the _async directory.

"""
Example demonstrating retry mechanisms with AgentBay SDK.

This example shows how to:
- Implement exponential backoff retry
- Handle transient failures
- Configure retry policies
- Track retry attempts
- Implement circuit breaker pattern
"""

import os
import time
from typing import Callable, Any, Optional
from dataclasses import dataclass

from agentbay import AgentBay
from agentbay import CreateSessionParams
from agentbay import AgentBayError


@dataclass
class RetryPolicy:
    """Configuration for retry behavior."""
    max_attempts: int = 3
    initial_delay: float = 1.0
    max_delay: float = 60.0
    exponential_base: float = 2.0
    jitter: bool = True


def retry_with_exponential_backoff(
    func: Callable,
    policy: RetryPolicy,
    *args,
    **kwargs
) -> Any:
    """Retry a function with exponential backoff."""
    
    for attempt in range(policy.max_attempts):
        try:
            print(f"  Attempt {attempt + 1}/{policy.max_attempts}...")
            result = func(*args, **kwargs)
            print(f"  ‚úÖ Success on attempt {attempt + 1}")
            return result
            
        except Exception as e:
            print(f"  ‚ùå Attempt {attempt + 1} failed: {e}")
            
            if attempt < policy.max_attempts - 1:
                # Calculate delay with exponential backoff
                delay = min(
                    policy.initial_delay * (policy.exponential_base ** attempt),
                    policy.max_delay
                )
                
                # Add jitter to prevent thundering herd
                if policy.jitter:
                    import random
                    delay = delay * (0.5 + random.random())
                
                print(f"  ‚è≥ Waiting {delay:.2f} seconds before retry...")
                time.sleep(delay)
            else:
                print(f"  ‚ùå All {policy.max_attempts} attempts failed")
                raise


def retry_command_execution(session, command: str, policy: RetryPolicy):
    """Execute a command with retry logic."""
    print(f"\nüîÑ Executing command with retry: {command}")
    
    def execute():
        result = session.command.execute_command(command)
        if not result.success:
            raise Exception(f"Command failed: {result.error_message}")
        return result
    
    try:
        result = retry_with_exponential_backoff(execute, policy)
        print(f"‚úÖ Command output: {result.output.strip()[:50]}")
        return result
    except Exception as e:
        print(f"‚ùå Command failed after all retries: {e}")
        return None


def retry_file_operation(session, file_path: str, content: str, policy: RetryPolicy):
    """Perform file operation with retry logic."""
    print(f"\nüìÅ Writing file with retry: {file_path}")
    
    def write_file():
        result = session.file_system.write_file(file_path, content)
        if not result.success:
            raise Exception(f"File write failed: {result.error_message}")
        return result
    
    try:
        result = retry_with_exponential_backoff(write_file, policy)
        print(f"‚úÖ File written successfully")
        return result
    except Exception as e:
        print(f"‚ùå File operation failed after all retries: {e}")
        return None


class CircuitBreaker:
    """Circuit breaker pattern implementation."""
    
    def __init__(self, failure_threshold: int = 3, timeout: float = 60.0):
        self.failure_threshold = failure_threshold
        self.timeout = timeout
        self.failure_count = 0
        self.last_failure_time = None
        self.state = "closed"  # closed, open, half-open
    
    def is_open(self) -> bool:
        """Check if circuit is open."""
        if self.state == "open":
            if time.time() - self.last_failure_time >= self.timeout:
                self.state = "half-open"
                print("  üîÑ Circuit breaker: half-open (testing)")
                return False
            return True
        return False
    
    def call(self, func: Callable, *args, **kwargs) -> Any:
        """Execute function through circuit breaker."""
        if self.is_open():
            print("  ‚õî Circuit breaker: open (blocking call)")
            raise Exception("Circuit breaker is open")
        
        try:
            result = func(*args, **kwargs)
            
            # Success - reset failure count
            if self.state == "half-open":
                self.state = "closed"
                print("  ‚úÖ Circuit breaker: closed (recovered)")
            self.failure_count = 0
            
            return result
            
        except Exception as e:
            self.failure_count += 1
            self.last_failure_time = time.time()
            
            if self.failure_count >= self.failure_threshold:
                self.state = "open"
                print(f"  ‚õî Circuit breaker: open (threshold reached: {self.failure_count})")
            
            raise


def demonstrate_circuit_breaker(session):
    """Demonstrate circuit breaker pattern."""
    print("\n‚ö° Demonstrating Circuit Breaker Pattern...")
    
    circuit_breaker = CircuitBreaker(failure_threshold=3, timeout=5.0)
    
    def unreliable_operation():
        # Simulate an operation that fails
        raise Exception("Simulated failure")
    
    # Try multiple times to trigger circuit breaker
    for i in range(5):
        print(f"\n  Call {i + 1}:")
        try:
            circuit_breaker.call(unreliable_operation)
        except Exception as e:
            print(f"  ‚ùå Call failed: {e}")
        
        time.sleep(0.5)
    
    # Wait for circuit to potentially close
    print("\n  Waiting for circuit breaker timeout...")
    time.sleep(5.5)
    
    print(f"\n  Circuit breaker state: {circuit_breaker.state}")


def main():
    """Main function demonstrating retry mechanisms."""
    api_key = os.getenv("AGENTBAY_API_KEY")
    if not api_key:
        print("‚ùå Error: AGENTBAY_API_KEY environment variable not set")
        return
    
    agent_bay = AgentBay(api_key=api_key)
    session = None
    
    try:
        print("=" * 60)
        print("Retry Mechanism Example")
        print("=" * 60)
        
        # Create session
        print("\nCreating session...")
        params = CreateSessionParams(image_id="linux_latest")
        result = agent_bay.create(params)
        
        if not result.success or not result.session:
            print(f"‚ùå Failed to create session: {result.error_message}")
            return
        
        session = result.session
        print(f"‚úÖ Session created: {session.session_id}")
        
        # Example 1: Basic retry with exponential backoff
        print("\n" + "=" * 60)
        print("Example 1: Exponential Backoff Retry")
        print("=" * 60)
        
        policy = RetryPolicy(max_attempts=3, initial_delay=1.0)
        retry_command_execution(session, "echo 'Hello World'", policy)
        
        # Example 2: Retry file operation
        print("\n" + "=" * 60)
        print("Example 2: Retry File Operation")
        print("=" * 60)
        
        retry_file_operation(
            session,
            "/tmp/retry_test.txt",
            "This is a test with retry",
            policy
        )
        
        # Example 3: Custom retry policy
        print("\n" + "=" * 60)
        print("Example 3: Custom Retry Policy")
        print("=" * 60)
        
        custom_policy = RetryPolicy(
            max_attempts=5,
            initial_delay=0.5,
            max_delay=10.0,
            exponential_base=2.0,
            jitter=True
        )
        
        retry_command_execution(session, "date", custom_policy)
        
        # Example 4: Circuit breaker pattern
        print("\n" + "=" * 60)
        print("Example 4: Circuit Breaker Pattern")
        print("=" * 60)
        
        demonstrate_circuit_breaker(session)
        
        print("\n‚úÖ Retry mechanism examples completed")
        
    except Exception as e:
        print(f"\n‚ùå Error: {e}")
        
    finally:
        if session:
            print("\nüßπ Cleaning up session...")
            agent_bay.delete(session)
            print("‚úÖ Session deleted")


if __name__ == "__main__":
    main()

