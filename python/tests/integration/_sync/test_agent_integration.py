# DO NOT EDIT THIS FILE MANUALLY.
# This file is auto-generated by scripts/generate_sync.py

"""Integration tests for Agent functionality."""

import os
import time

import pytest
import pytest

from agentbay import AgentBay
from agentbay._common.logger import get_logger
from agentbay._common.params.session_params import CreateSessionParams
from agentbay._sync.agent import Agent

logger = get_logger("agentbay-integration-test")


@pytest.fixture(scope="module")
def agent_bay():
    """Create an AgentBay instance."""
    api_key = os.getenv("AGENTBAY_API_KEY")
    if not api_key:
        pytest.skip("AGENTBAY_API_KEY environment variable not set")
    return AgentBay(api_key=api_key)


@pytest.fixture(scope="module")
def agent_session(agent_bay):
    """Create a session for agent testing."""
    # Ensure a delay to avoid session creation conflicts
    time.sleep(3)
    params = CreateSessionParams(
        image_id="windows_latest",
    )
    session_result = agent_bay.create(params)
    if not session_result.success or not session_result.session:
        pytest.skip("Failed to create session")

    session = session_result.session
    yield session

    # Clean up session
    try:
        session.delete()
    except Exception as e:
        print(f"Warning: Error deleting session: {e}")


@pytest.mark.sync
def test_execute_task_success(agent_session):
    """Test executing a flux task successfully."""
    agent = agent_session.agent

    task = "create a folder named 'agentbay' in C:\\Window\\Temp"
    max_try_times = os.environ.get("AGENT_TASK_TIMEOUT")
    if not max_try_times:
        max_try_times = 100
    print("ðŸš€ task of creating folders")
    result = agent.execute_task(task, int(max_try_times))
    assert result.success
    assert result.request_id != ""
    assert result.error_message == ""
    print(f"âœ… result {result.task_result}")


@pytest.mark.sync
def test_async_execute_task_success(agent_session):
    """Test executing a flux task successfully."""
    agent = agent_session.agent

    task = "create a folder named 'agentbay' in C:\\Window\\Temp"
    max_try_times = os.environ.get("AGENT_TASK_TIMEOUT")
    if not max_try_times:
        max_try_times = 100
    print("ðŸš€ async task of creating folders")
    result = agent.async_execute_task(task)
    assert result.success
    assert result.request_id != ""
    assert result.error_message == ""
    retry_times: int = 0
    query_result = None
    while retry_times < int(max_try_times):
        query_result = agent.get_task_status(result.task_id)
        assert result.success
        print(f"â³ Task {query_result.task_id} running ðŸš€: {query_result.task_action}.")
        if query_result.task_status == "finished":
            break
        retry_times += 1
        time.sleep(3)
    # Verify the final task status
    assert retry_times < int(max_try_times)
    print(f"âœ… result {query_result.task_product}")
