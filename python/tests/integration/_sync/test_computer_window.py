# DO NOT EDIT THIS FILE MANUALLY.
# This file is auto-generated by scripts/generate_sync.py

"""Integration tests for Computer window management functionality."""

import time
import os
import requests
from pathlib import Path

import pytest

from agentbay import AgentBay
from agentbay import CreateSessionParams


@pytest.fixture(scope="module")
def agent_bay():
    """Create AgentBay instance."""
    api_key = os.environ.get("AGENTBAY_API_KEY")
    if not api_key:
        pytest.skip("AGENTBAY_API_KEY environment variable not set")
    return AgentBay(api_key=api_key)

@pytest.fixture
def session(agent_bay):
    """Create a session with windows_latest image."""
    print("\nCreating session for computer window testing...")
    session_param = CreateSessionParams(image_id="windows_latest")
    result = agent_bay.create(session_param)
    assert result.success, f"Failed to create session: {result.error_message}"
    session = result.session
    print(f"Session created with ID: {session.session_id}")
    yield session
    print("\nCleaning up: Deleting the session...")
    session.delete()

def save_screenshot_from_url(screenshot_url: str, filename: str) -> None:
    """Download screenshot from URL and save as PNG file in python/screenshots directory."""
    # Get the current file's directory and navigate to python root
    current_dir = Path(__file__).parent
    python_root = current_dir.parent.parent.parent  # Go up from tests/integration/_async to python root
    screenshots_dir = python_root / "screenshots"
    
    # Create screenshots directory if it doesn't exist
    screenshots_dir.mkdir(exist_ok=True)
    
    print(f"DEBUG: Downloading screenshot from URL: {screenshot_url}")
    
    # Download the screenshot from URL using requests
    response = requests.get(screenshot_url)
    response.raise_for_status()
    image_data = response.content
    
    # Validate that we have some image data
    if len(image_data) == 0:
        raise ValueError("Downloaded image data is empty")
    
    print(f"DEBUG: Downloaded image data length: {len(image_data)} bytes")
    
    # Write to file
    file_path = screenshots_dir / filename
    with open(file_path, 'wb') as f:
        f.write(image_data)
    
    print(f"DEBUG: Successfully saved screenshot to {file_path}")

@pytest.mark.sync
def test_window_management_lifecycle(session):
    """Test complete window management lifecycle with ."""
    print("\nTest: Window Management Lifecycle...")
    
    # Start  app
    print("Starting  app...")
    installed_apps_result = session.computer.get_installed_apps()
    if installed_apps_result.success and len(installed_apps_result.data) > 0:
        print(f"  âœ… Found {len(installed_apps_result.data)} installed applications")
        
        # Find a suitable app to work with (prefer , fallback to first app)
        target_app = None
        target_app = installed_apps_result.data[0]
        app_name = getattr(target_app, 'name', 'Unknown App')
        print(f"  ðŸŽ¯ Selected {app_name} for demonstration")
        
        start_cmd = target_app.start_cmd
        print(f"  Starting start_cmd {start_cmd}...")
        app_name = getattr(target_app, 'name', 'Unknown App')
    assert installed_apps_result.success, f"Failed to start : {installed_apps_result.error_message}"
    assert len(installed_apps_result.data) > 0, "No processes returned"
    
    # Wait for app to be fully loaded
    time.sleep(3)
    
    # Start the application
    print(f"  Starting {app_name}...")
    app_pname = None
    start_result = session.computer.start_app(start_cmd)
    if start_result.success and len(start_result.data) > 0:
        print(f"  âœ… Application started successfully")
        
        # Get process information for cleanup
        first_process = start_result.data[0]
        app_pname = getattr(first_process, 'pname', None)
        
        # Wait for app to fully start
        time.sleep(3)
    window_id = None
   
    
    # Test ListRootWindows
    print("Testing list_root_windows...")
    windows_result = session.computer.list_root_windows()
    assert windows_result.success, f"List root windows failed: {windows_result.error_message}"
    assert windows_result.windows is not None, "Windows list should not be None"
    assert isinstance(windows_result.windows, list), "Windows should be a list"
    
    # Find  window
    for window in windows_result.windows:
        print(f"Found window: {window.title} (ID: {window.window_id})")
    
    target_window = windows_result.windows[0]
    window_id = target_window.window_id
    window_title = target_window.title
    print(f"  ðŸŽ¯ Selected window: ID={window_id}, Title='{window_title}'")
    
    assert window_id is not None, " window should be found in root windows list"
    assert window_id > 0, " window ID should be valid"
    
    # Test ActivateWindow
    print("Testing activate_window...")
    activate_result = session.computer.activate_window(window_id)
    assert activate_result.success, f"Activate window failed: {activate_result.error_message}"
    print(f"Successfully activated  window (ID: {window_id})")
    time.sleep(1)
    
    # Test GetActiveWindow
    print("Testing get_active_window...")
    active_result = session.computer.get_active_window()
    assert active_result.success, f"Get active window failed: {active_result.error_message}"
    assert active_result.window is not None, "Active window should not be None"
    
    if active_result.window:
        print(f"Active window: {active_result.window.title} (ID: {active_result.window.window_id})({window_id})")
    
    # Test FocusMode
    print("Testing focus_mode...")
    focus_on_result = session.computer.focus_mode(True)
    assert focus_on_result.success, f"Focus mode on failed: {focus_on_result.error_message}"
    print("Focus mode enabled successfully")
    time.sleep(1)
    
    focus_off_result = session.computer.focus_mode(False)
    assert focus_off_result.success, f"Focus mode off failed: {focus_off_result.error_message}"
    print("Focus mode disabled successfully")
    
    # Test MaximizeWindow
    print("Testing maximize_window...")
    maximize_result = session.computer.maximize_window(window_id)
    assert maximize_result.success, f"Maximize window failed: {maximize_result.error_message}"
    print(" window maximized successfully")
    time.sleep(2)
    
    # Take screenshot after maximize
    print("Taking screenshot after maximize...")
    screenshot_result = session.computer.screenshot()
    if screenshot_result.success and screenshot_result.data:
        try:
            save_screenshot_from_url(screenshot_result.data, "maximized.png")
            print("Maximized screenshot saved as maximized.png")
        except Exception as e:
            print(f"Warning: Failed to save maximized screenshot: {e}")
    else:
        print(f"Screenshot failed or returned empty data: {screenshot_result.error_message}")
    
    # Test MinimizeWindow
    print("Testing minimize_window...")
    minimize_result = session.computer.minimize_window(window_id)
    assert minimize_result.success, f"Minimize window failed: {minimize_result.error_message}"
    print(" window minimized successfully")
    time.sleep(2)
    
    # Take screenshot after minimize
    print("Taking screenshot after minimize...")
    screenshot_result = session.computer.screenshot()
    if screenshot_result.success and screenshot_result.data:
        try:
            save_screenshot_from_url(screenshot_result.data, "minimized.png")
            print("Minimized screenshot saved as minimized.png")
        except Exception as e:
            print(f"Warning: Failed to save minimized screenshot: {e}")
    else:
        print(f"Screenshot failed or returned empty data: {screenshot_result.error_message}")
    
    # Test RestoreWindow
    print("Testing restore_window...")
    restore_result = session.computer.restore_window(window_id)
    assert restore_result.success, f"Restore window failed: {restore_result.error_message}"
    print(" window restored successfully")
    time.sleep(2)
    
    # Take screenshot after restore
    print("Taking screenshot after restore...")
    screenshot_result = session.computer.screenshot()
    if screenshot_result.success and screenshot_result.data:
        try:
            save_screenshot_from_url(screenshot_result.data, "restored.png")
            print("Restored screenshot saved as restored.png")
        except Exception as e:
            print(f"Warning: Failed to save restored screenshot: {e}")
    else:
        print(f"Screenshot failed or returned empty data: {screenshot_result.error_message}")
    
    # Test ResizeWindow
    print("Testing resize_window...")
    resize_result = session.computer.resize_window(window_id, 600, 400)
    assert resize_result.success, f"Resize window failed: {resize_result.error_message}"
    print(" window resized to 600x400 successfully")
    time.sleep(2)
    
    # Take screenshot after resize
    print("Taking screenshot after resize...")
    screenshot_result = session.computer.screenshot()
    if screenshot_result.success and screenshot_result.data:
        try:
            save_screenshot_from_url(screenshot_result.data, "resized.png")
            print("Resized screenshot saved as resized.png")
        except Exception as e:
            print(f"Warning: Failed to save resized screenshot: {e}")
    else:
        print(f"Screenshot failed or returned empty data: {screenshot_result.error_message}")
    
    # Test FullscreenWindow
    print("Testing fullscreen_window...")
    fullscreen_result = session.computer.fullscreen_window(window_id)
    assert fullscreen_result.success, f"Fullscreen window failed: {fullscreen_result.error_message}"
    print(" window set to fullscreen successfully")
    time.sleep(2)
    
    # Take screenshot after fullscreen
    print("Taking screenshot after fullscreen...")
    screenshot_result = session.computer.screenshot()
    if screenshot_result.success and screenshot_result.data:
        try:
            save_screenshot_from_url(screenshot_result.data, "fullscreen.png")
            print("Fullscreen screenshot saved as fullscreen.png")
        except Exception as e:
            print(f"Warning: Failed to save fullscreen screenshot: {e}")
    else:
        print(f"Screenshot failed or returned empty data: {screenshot_result.error_message}")
    
    # Cleanup - CloseWindow
    print("Cleaning up: Closing  window...")
    close_result = session.computer.close_window(window_id)
    if close_result.success:
        print(" window closed successfully")
    else:
        print(f"Warning: Failed to close  window: {close_result.error_message}")

@pytest.mark.sync
def test_list_root_windows(session):
    """Test listing root windows."""
    print("\nTest: Listing root windows...")
    
    # Act
    result = session.computer.list_root_windows()
    
    # Assert
    assert result.success, f"List root windows failed: {result.error_message}"
    assert result.windows is not None, "Windows list should not be None"
    assert isinstance(result.windows, list), "Windows should be a list"
    print(f"Found {len(result.windows)} root windows")
    
    if len(result.windows) > 0:
        window = result.windows[0]
        assert hasattr(window, "title"), "Window should have title"
        assert hasattr(window, "window_id"), "Window should have window_id"
        print(f"First window: {window.title} (ID: {window.window_id})")

@pytest.mark.sync
def test_get_active_window(session):
    """Test getting the active window."""
    print("\nTest: Getting active window...")
    
    # Act
    result = session.computer.get_active_window()
    
    # Assert
    assert result.success, f"Get active window failed: {result.error_message}"
    # Note: active window might be None if no window is active
    if result.window:
        assert hasattr(result.window, "title"), "Active window should have title"
        assert hasattr(result.window, "window_id"), "Active window should have window_id"
        print(f"Active window: {result.window.title} (ID: {result.window.window_id})")
    else:
        print("No active window found")

@pytest.mark.sync
def test_focus_mode(session):
    """Test focus mode functionality."""
    print("\nTest: Focus mode...")
    
    # Test enabling focus mode
    result_on = session.computer.focus_mode(True)
    assert result_on.success, f"Focus mode on failed: {result_on.error_message}"
    print("Focus mode enabled successfully")
    
    time.sleep(1)
    
    # Test disabling focus mode
    result_off = session.computer.focus_mode(False)
    assert result_off.success, f"Focus mode off failed: {result_off.error_message}"
    print("Focus mode disabled successfully")

@pytest.mark.sync
def test_screenshot(session):
    """Test screenshot functionality."""
    print("\nTest: Screenshot...")
    
    # Take a screenshot
    result = session.computer.screenshot()
    
    # Assert
    assert result.success, f"Screenshot failed: {result.error_message}"
    assert result.data is not None, "Screenshot data should not be None"
    assert isinstance(result.data, str), "Screenshot data should be a string (URL)"
    assert len(result.data) > 0, "Screenshot data should not be empty"
    print(f"Screenshot taken successfully: {result.data}")
    
    # Save screenshot to file
    if result.success and result.data:
        try:
            save_screenshot_from_url(result.data, "test_screenshot.png")
            print("Test screenshot saved as test_screenshot.png")
        except Exception as e:
            print(f"Warning: Failed to save test screenshot: {e}")

