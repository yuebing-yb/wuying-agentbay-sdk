# DO NOT EDIT THIS FILE MANUALLY.
# This file is auto-generated by scripts/generate_sync.py

"""Integration tests for Context full lifecycle operations.

This module tests the complete context lifecycle including:
- Context creation and deletion
- File upload and download within a context
- Cross-session context synchronization
"""

import os
import time
from uuid import uuid4

import pytest
import pytest

from agentbay import AgentBay
from agentbay import AgentBayError
from agentbay import ContextSync
from agentbay import CreateSessionParams
from agentbay import Config


def get_test_api_key():
    """Get API key for testing."""
    return os.environ.get("AGENTBAY_API_KEY")


def get_test_endpoint():
    """Get endpoint for testing."""
    return os.environ.get("AGENTBAY_ENDPOINT")


@pytest.fixture(scope="class")
def agent_bay():
    """Fixture to provide AgentBay instance."""
    api_key = get_test_api_key()
    if not api_key:
        pytest.skip("AGENTBAY_API_KEY environment variable not set")
    
    endpoint = get_test_endpoint()
    
    if endpoint:
        config = Config(endpoint=endpoint, timeout_ms=60000)
        agent_bay = AgentBay(api_key=api_key, cfg=config)
        print(f"Using endpoint: {endpoint}")
    else:
        agent_bay = AgentBay(api_key=api_key)
        print("Using default endpoint")
    
    test_contexts = []  # Track contexts for cleanup
    
    yield agent_bay, test_contexts
    
    # Cleanup
    print("\nCleaning up test contexts...")
    for context_info in test_contexts:
        try:
            if isinstance(context_info, dict):
                context_id = context_info["id"]
                context_name = context_info["name"]
            else:
                context_id = context_info
                context_name = None
            
            if context_name:
                get_result = agent_bay.context.get(context_name)
                if get_result.success and get_result.context:
                    result = agent_bay.context.delete(get_result.context)
                    if result.success:
                        print(f"  ✓ Deleted context: {context_id}")
                    else:
                        print(f"  ✗ Failed to delete context: {context_id}")
                else:
                    print(f"  ✗ Context not found: {context_id}")
            else:
                print(f"  ⚠ Skipping cleanup for: {context_id} (no name)")
        except Exception as e:
            print(f"  ✗ Error deleting context {context_id}: {e}")


class TestContextFullLifecycle:
    """Integration tests for Context full lifecycle operations."""

    @pytest.mark.sync
    def test_context_full_lifecycle_single_session(self, agent_bay):
        """
        Scenario 1: Complete context lifecycle within a single session.

        Test steps:
        1. Create a context
        2. Create a session with context sync
        3. Basic verification
        4. Clean up
        """
        agent_bay_instance, test_contexts = agent_bay
        
        print("\n" + "=" * 70)
        print("TEST: Context Full Lifecycle in Single Session")
        print("=" * 70)

        # Step 1: Create a context
        print("\nStep 1: Creating a test context...")
        context_name = f"test-lifecycle-{uuid4().hex[:8]}"
        context_result = agent_bay_instance.context.create(context_name)
        assert context_result.success, f"Failed to create context: {context_result.error_message}"
        
        context = context_result.context
        test_contexts.append({"id": context.id, "name": context.name})
        print(f"  ✓ Context created: {context.name} (ID: {context.id})")

        # Step 2: Create a session with context sync
        print("\nStep 2: Creating session with context sync...")
        test_path = "/tmp/lifecycle_test"

        params = CreateSessionParams(
            context_syncs=[ContextSync(context_id=context.id, path=test_path)]
        )
        session_result = agent_bay_instance.create(params=params)
        assert session_result.success, f"Failed to create session: {session_result.error_message}"
        
        session = session_result.session
        print(f"  ✓ Session created: {session.session_id}")

        # Step 3: Basic verification
        print("\nStep 3: Basic test completed")
        
        # Clean up session
        print("\nStep 4: Cleaning up session...")
        session_delete_result = session.delete()
        assert session_delete_result.success, f"Failed to delete session: {session_delete_result.error_message}"
        print(f"  ✓ Session deleted successfully")

        print("\n" + "=" * 70)
        print("✅ Context Full Lifecycle Test PASSED")
        print("=" * 70)

    @pytest.mark.sync
    def test_context_cross_session_persistence(self, agent_bay):
        """
        Scenario 2: Test context persistence across multiple sessions.
        """
        agent_bay_instance, test_contexts = agent_bay
        
        print("\n" + "=" * 70)
        print("TEST: Context Cross-Session Persistence")
        print("=" * 70)
        
        # Create a context
        print("\nStep 1: Creating a test context...")
        context_name = f"test-cross-session-{uuid4().hex[:8]}"
        context_result = agent_bay_instance.context.create(context_name)
        assert context_result.success, f"Failed to create context: {context_result.error_message}"
        
        context = context_result.context
        test_contexts.append({"id": context.id, "name": context.name})
        print(f"  ✓ Context created: {context.name} (ID: {context.id})")
        
        # Test basic context operations
        print("\nStep 2: Testing basic context operations...")
        # Add more test logic here if needed
        print("  ✓ Context cross-session test completed")