# DO NOT EDIT THIS FILE MANUALLY.
# This file is auto-generated by scripts/generate_sync.py

import os

import pytest

from agentbay import AgentBay, CreateSessionParams


@pytest.mark.sync
def test_link_url_session_mcp_tools_and_call_tool():
    api_key = os.getenv("AGENTBAY_API_KEY")
    if not api_key:
        pytest.skip("AGENTBAY_API_KEY environment variable not set")

    agent_bay = AgentBay(api_key=api_key)

    params = CreateSessionParams(
        image_id="acs-test-code-space-debian-12",
        labels={"test-type": "link-url-integration"},
    )

    result = agent_bay.create(params)
    assert result.success, result.error_message
    assert result.session is not None

    session = result.session
    try:
        assert session.get_token() != ""
        assert session.get_link_url() != ""
        assert len(session.mcp_tools) > 0

        # Force using LinkUrl route (not legacy ip:port route)
        session.network_interface_ip = ""
        session.http_port = ""

        cmd_result = session.command.execute_command("echo link-url-route-ok")
        assert cmd_result.success, cmd_result.error_message
        assert "link-url-route-ok" in cmd_result.output
    finally:
        session.delete()


@pytest.mark.sync
def test_link_url_session_run_code():
    """
    Integration test for LinkUrl session with run_code.
    Requires environment variable: AGENTBAY_API_KEY
    """
    api_key = os.getenv("AGENTBAY_API_KEY")
    if not api_key:
        pytest.skip("AGENTBAY_API_KEY environment variable not set")

    # Create AgentBay client
    agent_bay = AgentBay(api_key=api_key)

    # Create a session with code_latest image (needed for run_code)
    session_result = agent_bay.create(
        CreateSessionParams(
            image_id="acs-test-code-space-debian-12",
        )
    )
    assert session_result.success, f"Create session failed: {session_result.error_message}"
    session = session_result.session
    print(f"Session created: {session.session_id}")

    try:
        # Test run_code
        print("Testing run_code via LinkUrl...")
        code_result = session.code.run_code("print('hello from link url')", "python")
        assert code_result.success, f"Run code failed: {code_result.error_message}"
        assert "hello from link url" in code_result.result, f"Unexpected result: {code_result.result}"
        print("run_code passed")

        # Test command run (shell)
        print("Testing command.execute_command via LinkUrl...")
        cmd_result = session.command.execute_command("echo 'hello shell'")
        assert cmd_result.success, f"Command run failed: {cmd_result.error_message}"
        # command.execute_command returns CommandResult with output/stdout
        assert "hello shell" in (cmd_result.stdout or cmd_result.output or ""), f"Unexpected shell output: {cmd_result.stdout}"
        print("command.execute_command passed")

        # Test file_system (list directory)
        print("Testing file_system.list_directory via LinkUrl...")
        fs_result = session.file_system.list_directory("/tmp")
        assert fs_result.success, f"List directory failed: {fs_result.error_message}"
        assert isinstance(fs_result.entries, list), "Entries should be a list"
        print("file_system.list_directory passed")

    finally:
        # Cleanup
        delete_result = session.delete()
        assert delete_result.success, f"Delete session failed: {delete_result.error_message}"
        print("Session deleted")