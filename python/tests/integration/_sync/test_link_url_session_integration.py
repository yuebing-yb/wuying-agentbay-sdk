# DO NOT EDIT THIS FILE MANUALLY.
# This file is auto-generated by scripts/generate_sync.py

import os

import pytest

from agentbay import AgentBay, CreateSessionParams


@pytest.mark.sync
def test_link_url_session_mcp_tools_and_call_tool():
    api_key = os.getenv("AGENTBAY_API_KEY")
    if not api_key:
        pytest.skip("AGENTBAY_API_KEY environment variable not set")

    agent_bay = AgentBay(api_key=api_key)

    image_id = os.getenv("AGENTBAY_IMAGE_ID") or "linux_latest"
    params = CreateSessionParams(
        image_id=image_id,
        labels={"test-type": "link-url-integration"},
    )

    result = agent_bay.create(params)
    assert result.success, result.error_message
    assert result.session is not None

    session = result.session
    try:
        if session.get_token() == "" or session.get_link_url() == "":
            pytest.skip("LinkUrl/token not provided by CreateSession response in this environment")

        cmd_result = session.command.execute_command("echo link-url-route-ok")
        assert cmd_result.success, cmd_result.error_message
        assert "link-url-route-ok" in cmd_result.output

        direct = session.call_mcp_tool(
            "shell",
            {"command": "echo direct-link-url-route-ok"},
        )
        assert direct.success, direct.error_message
        assert "direct-link-url-route-ok" in direct.data
    finally:
        session.delete()


@pytest.mark.sync
def test_link_url_session_run_code():
    """
    Integration test for LinkUrl session with run_code.
    Requires environment variable: AGENTBAY_API_KEY
    """
    api_key = os.getenv("AGENTBAY_API_KEY")
    if not api_key:
        pytest.skip("AGENTBAY_API_KEY environment variable not set")

    agent_bay = AgentBay(api_key=api_key)

    image_id = os.getenv("AGENTBAY_CODE_IMAGE_ID") or "code_latest"
    session_result = agent_bay.create(
        CreateSessionParams(
            image_id=image_id,
        )
    )
    assert session_result.success, f"Create session failed: {session_result.error_message}"
    session = session_result.session
    assert session is not None

    try:
        if session.get_token() == "" or session.get_link_url() == "":
            pytest.skip("LinkUrl/token not provided by CreateSession response in this environment")

        code_result = session.code.run_code("print('hello from link url')", "python")
        assert code_result.success, f"Run code failed: {code_result.error_message}"
        assert "hello from link url" in code_result.result, f"Unexpected result: {code_result.result}"

        cmd_result = session.command.execute_command("echo 'hello shell'")
        assert cmd_result.success, f"Command run failed: {cmd_result.error_message}"
        assert "hello shell" in (cmd_result.stdout or cmd_result.output or ""), f"Unexpected shell output: {cmd_result.stdout}"

        fs_result = session.file_system.list_directory("/tmp")
        assert fs_result.success, f"List directory failed: {fs_result.error_message}"
        assert isinstance(fs_result.entries, list), "Entries should be a list"
    finally:
        delete_result = session.delete()
        assert delete_result.success, f"Delete session failed: {delete_result.error_message}"

