import time
# DO NOT EDIT THIS FILE MANUALLY.
# This file is auto-generated by scripts/generate_sync.py

import os
import pytest
import pytest

from agentbay import AgentBay
from agentbay import MobileExtraConfig, MobileSimulateMode
from agentbay import Session
from agentbay import CreateSessionParams, ExtraConfigs
from agentbay import MobileSimulateService


MOBILE_INFO_MODEL_A = "SM-A505F"
MOBILE_INFO_MODEL_B = "moto g stylus 5G - 2024"

mobile_sim_persistence_context_id = None


@pytest.fixture(scope="module")
def agent_bay():
    """
    Set up the test environment by creating an AgentBay instance.
    """
    api_key = os.getenv(
        "AGENTBAY_API_KEY", "your_api_key"
    )  # Replace with your actual API key
    return AgentBay(api_key=api_key)


@pytest.mark.sync
def test_mobile_simulate_for_model_a(agent_bay):
    """
    Test device properties after mobile simulate for model a.
    """
    global mobile_sim_persistence_context_id
    # Get a mobile dev info file from DumpSDK or real device library
    print("Upload mobile dev info file...")
    mobile_sim_persistence_context_id = None
    mobile_info_file_path = os.path.join(
            os.path.dirname(os.path.dirname(os.path.dirname(os.path.dirname(os.path.dirname(__file__))))), 
            "resource", "mobile_info_model_a.json"
    )
    with open(mobile_info_file_path, "r") as f:
        mobile_info_content = f.read()
    
    # Create mobile simulate service and set simulate params
    simulate_service = MobileSimulateService(agent_bay)
    simulate_service.set_simulate_enable(True)
    simulate_service.set_simulate_mode(MobileSimulateMode.PROPERTIES_ONLY)
    
    upload_result = simulate_service.upload_mobile_info(mobile_info_content)
    assert upload_result.success, f"Failed to upload mobile dev info file: {upload_result.error_message}"
    mobile_sim_persistence_context_id = upload_result.mobile_simulate_context_id
    print(f"Mobile dev info uploaded successfully: {mobile_sim_persistence_context_id}")

    params = CreateSessionParams(
        image_id="mobile_latest",
        extra_configs=ExtraConfigs(
            mobile=MobileExtraConfig(
                simulate_config=simulate_service.get_simulate_config()
            )
        )
    )
    result = agent_bay.create(params)
    session = None
    assert result.success, "Failed to create session"
    assert result.session is not None, "Session should not be None"
    session = result.session
    print(f"Session created successfully: {session.session_id}")

    # Wait for mobile simulate to complete
    time.sleep(5)
    print("Getting device model after mobile simulate for model a...")
    result = session.command.execute_command("getprop ro.product.model")
    assert result.success, "Failed to get device model"
    model_a_product_model = result.output.strip()
    print(f"Simulated model a mobile product model: {model_a_product_model}")
    assert model_a_product_model == MOBILE_INFO_MODEL_A, f"Device model should be {MOBILE_INFO_MODEL_A}"

    time.sleep(2)
    print("Deleting session...")
    delete_result = agent_bay.delete(session)
    assert delete_result.success, "Failed to delete session"
    print(f"Session deleted successfully (RequestID: {delete_result.request_id})")



@pytest.mark.sync
def test_mobile_simulate_for_model_b(agent_bay):
    """
    Test device properties after mobile simulate for model b.
    """
    # Get a mobile dev info file from DumpSDK or real device library
    print("Upload mobile model b dev info file...")
    mobile_sim_context_id = None
    mobile_info_file_path = os.path.join(
            os.path.dirname(os.path.dirname(os.path.dirname(os.path.dirname(os.path.dirname(__file__))))), 
            "resource", "mobile_info_model_b.json"
    )
    with open(mobile_info_file_path, "r") as f:
        mobile_info_content = f.read()
    
    # Create mobile simulate service and set simulate params
    simulate_service = MobileSimulateService(agent_bay)
    simulate_service.set_simulate_enable(True)
    simulate_service.set_simulate_mode(MobileSimulateMode.PROPERTIES_ONLY)
    
    upload_result = simulate_service.upload_mobile_info(mobile_info_content)
    assert upload_result.success, f"Failed to upload mobile dev info file: {upload_result.error_message}"
    mobile_sim_context_id = upload_result.mobile_simulate_context_id
    print(f"Mobile model b dev info uploaded successfully: {mobile_sim_context_id}")

    params = CreateSessionParams(
        image_id="mobile_latest",
        extra_configs=ExtraConfigs(
            mobile=MobileExtraConfig(
                simulate_config=simulate_service.get_simulate_config()
            )
        )
    )
    result = agent_bay.create(params)
    session = None
    assert result.success, "Failed to create session"
    assert result.session is not None, "Session should not be None"
    session = result.session
    print(f"Session created successfully: {session.session_id}")

    # Wait for mobile simulate to complete
    time.sleep(5)
    print("Getting device model after mobile simulate for model b...")
    result = session.command.execute_command("getprop ro.product.model")
    assert result.success, "Failed to get device model"
    model_b_product_model = result.output.strip()
    print(f"Simulated model b mobile product model: {model_b_product_model}")
    assert model_b_product_model == MOBILE_INFO_MODEL_B, f"Device model should be {MOBILE_INFO_MODEL_B}"

    time.sleep(2)
    print("Deleting session...")
    delete_result = agent_bay.delete(session)
    assert delete_result.success, "Failed to delete session"
    print(f"Session deleted successfully (RequestID: {delete_result.request_id})")



@pytest.mark.sync
def test_mobile_simulate_persistence(agent_bay):
    """
    Using model a simulate context to test persistence mobile simulate across sessions.
    """
    global mobile_sim_persistence_context_id
    # Directly use model a simulate context id to do mobile simulate across sessions.
    # Create mobile simulate service and set simulate params
    simulate_service = MobileSimulateService(agent_bay)
    simulate_service.set_simulate_enable(True)
    simulate_service.set_simulate_mode(MobileSimulateMode.PROPERTIES_ONLY)
    simulate_service.set_simulate_context_id(mobile_sim_persistence_context_id)
    
    params = CreateSessionParams(
        image_id="mobile_latest",
        extra_configs=ExtraConfigs(
            mobile=MobileExtraConfig(
                simulate_config=simulate_service.get_simulate_config()
            )
        )
    )
    result = agent_bay.create(params)
    session = None
    assert result.success, "Failed to create session"
    assert result.session is not None, "Session should not be None"
    session = result.session
    print(f"Session created successfully: {session.session_id}")

    # Wait for mobile simulate to complete
    time.sleep(5)
    print("Getting device model after mobile simulate...")
    result = session.command.execute_command("getprop ro.product.model")
    assert result.success, "Failed to get device model"
    persistence_product_model = result.output.strip()
    print(f"Persistent simulated mobile product model: {persistence_product_model}")
    assert persistence_product_model == MOBILE_INFO_MODEL_A, f"Device model should be {MOBILE_INFO_MODEL_A}"

    time.sleep(2)
    print("Deleting session...")
    delete_result = agent_bay.delete(session)
    assert delete_result.success, "Failed to delete session"
    print(f"Session deleted successfully (RequestID: {delete_result.request_id})")
